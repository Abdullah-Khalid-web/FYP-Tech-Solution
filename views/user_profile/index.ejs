<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - <%= shop.name || 'Retail Management System' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4e73df;
            --success: #1cc88a;
            --warning: #f6c23e;
            --danger: #e74a3b;
            --info: #36b9cc;
            --secondary: #858796;
            --dark: #5a5c69;
            --light: #f8f9fc;
        }

        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-container {
            padding: 20px;
            background-color: #f5f7fa;
            min-height: 100vh;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
            margin: 0;
            color: var(--dark);
        }

        .datetime {
            color: var(--secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .shop-info {
            text-align: right;
        }

        .shop-info p {
            margin: 5px 0;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .shop-info i {
            margin-right: 5px;
            color: var(--primary);
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: none;
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 10px 10px 0 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .section-header h2 {
            font-size: 1.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            color: var(--dark);
        }

        .section-header h2 i {
            margin-right: 10px;
            color: var(--primary);
        }

        /* Profile Header */
        .profile-header {
            background: linear-gradient(135deg, var(--primary), #2e59d9);
            color: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid rgba(255, 255, 255, 0.3);
            object-fit: cover;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover::after {
            opacity: 1;
        }

        .stat-icon {
            font-size: 2rem;
            margin-right: 20px;
            z-index: 1;
        }

        .stat-info {
            z-index: 1;
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin: 0;
        }

        .stat-info p {
            margin: 5px 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        /* Quick Actions */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .action-card {
            background: white;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
            color: var(--primary);
            text-decoration: none;
        }

        .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 1.2rem;
            color: white;
        }

        .action-card p {
            margin: 0;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Form Controls */
        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        /* Activity Items */
        .activity-item {
            padding: 15px;
            border-left: 4px solid var(--primary);
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s;
        }

        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .salary-paid {
            border-left-color: var(--success);
        }

        .salary-pending {
            border-left-color: var(--warning);
        }

        .loan-item {
            border-left-color: var(--danger);
        }

        /* Badge Styles */
        .badge {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.35em 0.65em;
        }

        /* Button Styles */
        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 8px 16px;
        }

        .btn-outline {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s ease;
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: transparent;
        }

        /* Tabs */
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 20px;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: transparent;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 3rem;
            color: #d1d5db;
            margin-bottom: 1rem;
        }

        /* Info Items */
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: var(--secondary);
            min-width: 150px;
        }

        .info-value {
            color: #2d3748;
        }

        /* Color Classes */
        .bg-primary { background-color: var(--primary); }
        .bg-success { background-color: var(--success); }
        .bg-warning { background-color: var(--warning); }
        .bg-danger { background-color: var(--danger); }
        .bg-info { background-color: var(--info); }
        .bg-secondary { background-color: var(--secondary); }

        /* Profile Picture Upload */
        .profile-picture-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #ddd;
            margin-bottom: 10px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .shop-info {
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .action-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1><i class="fas fa-user-circle me-2"></i>User Profile</h1>
                <p class="datetime" id="datetime"></p>
            </div>
            <div class="shop-info">
                <p><i class="fas fa-store"></i> <%= shop.name || 'My Shop' %></p>
                <p><i class="fas fa-map-marker-alt"></i> <%= shop.address || 'Add shop address' %></p>
            </div>
        </div>

        <!-- Alert Messages -->
        <% if (success) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i> <%= success %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>
        
        <% if (error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i> <%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

        <!-- Profile Header -->
        <div class="profile-header">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="profile-avatar">
                        <% if (user.profile_picture) { %>
                            <img src="/uploads/profiles/<%= user.profile_picture %>" 
                                 alt="Profile Picture" 
                                 class="profile-avatar-img"
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-user\'></i>';">
                        <% } else { %>
                            <i class="fas fa-user"></i>
                        <% } %>
                    </div>
                </div>
                <div class="col">
                    <h1 class="h2 mb-2"><%= user.name %></h1>
                    <p class="mb-1">
                        <i class="fas fa-user-tag me-2"></i> 
                        <span class="text-capitalize"><%= user.role || 'User' %></span>
                    </p>
                    <p class="mb-1">
                        <i class="fas fa-store me-2"></i> <%= shop.name || 'My Shop' %>
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-calendar me-2"></i> 
                        Member since <%= new Date(user.created_at).toLocaleDateString('en-IN', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        }) %>
                    </p>
                </div>
                <div class="col-auto">
                    <span class="badge <%= user.status === 'active' ? 'bg-success' : 'bg-danger' %> fs-6 p-2">
                        <i class="fas fa-circle me-1"></i> 
                        <%= user.status ? user.status.charAt(0).toUpperCase() + user.status.slice(1) : 'Active' %>
                    </span>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card bg-primary">
                <div class="stat-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="stat-info">
                    <h3><%= activities.length %></h3>
                    <p>Recent Activities</p>
                </div>
            </div>

            <div class="stat-card bg-success">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3><%= salaryHistory.filter(s => s.status === 'paid').length %></h3>
                    <p>Paid Salaries</p>
                </div>
            </div>

            <div class="stat-card bg-warning">
                <div class="stat-icon">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
                <div class="stat-info">
                    <h3><%= loanHistory.length %></h3>
                    <p>Total Loans</p>
                </div>
            </div>

            <div class="stat-card bg-info">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-info">
                    <h3><%= new Date(user.created_at).getFullYear() %></h3>
                    <p>Member Since</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Sidebar -->
            <div class="col-lg-4">
                <!-- Shop Information -->
                <div class="card">
                    <div class="section-header">
                        <h2><i class="fas fa-store"></i> Shop Information</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <span class="info-label">Shop Name:</span>
                            <span class="info-value"><%= shop.name || 'My Shop' %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Plan:</span>
                            <span class="info-value">
                                <span class="badge bg-primary text-capitalize">
                                    <%= shop.plan || 'Basic' %>
                                </span>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Currency:</span>
                            <span class="info-value"><%= shop.currency || 'PKR' %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Address:</span>
                            <span class="info-value"><%= shop.address || 'Not provided' %></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Contact:</span>
                            <span class="info-value"><%= shop.phone || 'Not provided' %></span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="section-header">
                        <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                    </div>
                    <div class="card-body">
                        <div class="action-grid">
                            <a href="/dashboard" class="action-card">
                                <div class="action-icon bg-primary">
                                    <i class="fas fa-tachometer-alt"></i>
                                </div>
                                <p>Dashboard</p>
                            </a>
                            
                            <a href="#activity" class="action-card" onclick="switchTab('activity')">
                                <div class="action-icon bg-info">
                                    <i class="fas fa-history"></i>
                                </div>
                                <p>View Activity</p>
                            </a>
                            
                            <a href="#" class="action-card" data-bs-toggle="modal" data-bs-target="#passwordModal">
                                <div class="action-icon bg-warning">
                                    <i class="fas fa-key"></i>
                                </div>
                                <p>Change Password</p>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Tabs Navigation -->
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs" id="profileTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#personal">
                                    <i class="fas fa-user me-2"></i> Personal Info
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#salary">
                                    <i class="fas fa-money-bill me-2"></i> Salary History
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#loans">
                                    <i class="fas fa-hand-holding-usd me-2"></i> Loans
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#activity">
                                    <i class="fas fa-history me-2"></i> Recent Activity
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <!-- Tabs Content -->
                        <div class="tab-content">
                            <!-- Personal Info Tab -->
                            <div class="tab-pane fade show active" id="personal">
                                <form method="POST" action="/user_profile" enctype="multipart/form-data" id="profileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" name="name" 
                                                   value="<%= user.name %>" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Email *</label>
                                            <input type="email" class="form-control" name="email" 
                                                   value="<%= user.email %>" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Phone</label>
                                            <input type="tel" class="form-control" name="phone" 
                                                   value="<%= user.phone || '' %>" 
                                                   pattern="[0-9]{10,15}">
                                            <small class="text-muted">Enter 10-15 digit phone number</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">CNIC</label>
                                            <input type="text" class="form-control" name="cnic" 
                                                   value="<%= user.cnic || '' %>"
                                                   pattern="[0-9]{13}">
                                            <small class="text-muted">Enter 13-digit CNIC without dashes</small>
                                        </div>
                                    </div>

                                    <% if (user.role === 'owner' || user.role === 'admin') { %>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Monthly Salary (<%= shop.currency || 'PKR' %>)</label>
                                            <input type="number" class="form-control" name="salary" 
                                                   value="<%= user.salary || '' %>" step="0.01" min="0">
                                        </div>
                                    </div>
                                    <% } %>

                                    <div class="mb-3">
                                        <label class="form-label">Profile Picture</label>
                                        <% if (user.profile_picture) { %>
                                            <div class="mb-2">
                                                <img src="/uploads/profiles/<%= user.profile_picture %>" 
                                                     alt="Current Profile" 
                                                     class="profile-picture-preview"
                                                     onerror="this.style.display='none';">
                                            </div>
                                        <% } %>
                                        <input type="file" class="form-control" name="profile_picture" 
                                               accept="image/*" id="profilePictureInput">
                                        <small class="text-muted">Max 2MB. JPG, PNG, GIF allowed. Leave empty to keep current.</small>
                                        <div class="mt-2">
                                            <img id="profilePicturePreview" class="profile-picture-preview" style="display: none;">
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i> Update Profile
                                        </button>
                                        <button type="button" class="btn btn-outline" data-bs-toggle="modal" data-bs-target="#passwordModal">
                                            <i class="fas fa-key me-2"></i> Change Password
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Salary History Tab -->
                            <div class="tab-pane fade" id="salary">
                                <% if (salaryHistory.length > 0) { %>
                                    <% salaryHistory.forEach(salary => { %>
                                        <div class="activity-item <%= salary.status === 'paid' ? 'salary-paid' : 'salary-pending' %>">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">
                                                        <%= salary.month %> - <%= shop.currency || 'PKR' %> 
                                                        <%= (salary.amount || 0).toLocaleString('en-IN', { 
                                                            minimumFractionDigits: 2, 
                                                            maximumFractionDigits: 2 
                                                        }) %>
                                                    </h6>
                                                    <% if (salary.paid_on) { %>
                                                        <small class="text-muted">
                                                            Paid on: <%= new Date(salary.paid_on).toLocaleDateString('en-IN', { 
                                                                year: 'numeric', 
                                                                month: 'long', 
                                                                day: 'numeric' 
                                                            }) %>
                                                        </small>
                                                    <% } %>
                                                    <% if (salary.notes) { %>
                                                        <p class="mb-0 mt-1"><small><%= salary.notes %></small></p>
                                                    <% } %>
                                                </div>
                                                <span class="badge <%= salary.status === 'paid' ? 'bg-success' : 'bg-warning' %>">
                                                    <%= salary.status ? salary.status.charAt(0).toUpperCase() + salary.status.slice(1) : 'Pending' %>
                                                </span>
                                            </div>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <div class="empty-state">
                                        <div class="empty-state-icon">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </div>
                                        <h5>No salary history found</h5>
                                        <p class="text-muted">Your salary records will appear here once they are processed.</p>
                                    </div>
                                <% } %>
                            </div>

                            <!-- Loans Tab -->
                            <div class="tab-pane fade" id="loans">
                                <% if (loanHistory.length > 0) { %>
                                    <% loanHistory.forEach(loan => { %>
                                        <div class="activity-item loan-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">
                                                        <%= shop.currency || 'PKR' %> 
                                                        <%= (loan.amount || 0).toLocaleString('en-IN', { 
                                                            minimumFractionDigits: 2, 
                                                            maximumFractionDigits: 2 
                                                        }) %>
                                                    </h6>
                                                    <p class="mb-1 text-muted">
                                                        Taken on: <%= new Date(loan.taken_on).toLocaleDateString('en-IN', { 
                                                            year: 'numeric', 
                                                            month: 'long', 
                                                            day: 'numeric' 
                                                        }) %>
                                                    </p>
                                                    <% if (loan.due_amount > 0) { %>
                                                        <p class="mb-1">
                                                            Due Amount: <%= shop.currency || 'PKR' %> 
                                                            <%= (loan.due_amount || 0).toLocaleString('en-IN', { 
                                                                minimumFractionDigits: 2, 
                                                                maximumFractionDigits: 2 
                                                            }) %>
                                                        </p>
                                                    <% } %>
                                                    <% if (loan.notes) { %>
                                                        <p class="mb-0 mt-1"><small><%= loan.notes %></small></p>
                                                    <% } %>
                                                </div>
                                                <span class="badge <%= loan.status === 'repaid' ? 'bg-success' : loan.status === 'partial' ? 'bg-warning' : 'bg-danger' %>">
                                                    <%= loan.status ? loan.status.charAt(0).toUpperCase() + loan.status.slice(1) : 'Active' %>
                                                </span>
                                            </div>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <div class="empty-state">
                                        <div class="empty-state-icon">
                                            <i class="fas fa-hand-holding-usd"></i>
                                        </div>
                                        <h5>No loan history found</h5>
                                        <p class="text-muted">Your loan records will appear here once they are processed.</p>
                                    </div>
                                <% } %>
                            </div>

                            <!-- Activity Tab -->
                            <div class="tab-pane fade" id="activity">
                                <% if (activities.length > 0) { %>
                                    <% activities.forEach(activity => { %>
                                        <div class="activity-item">
                                            <div class="d-flex justify-content-between">
                                                <h6 class="mb-1"><%= activity.action %></h6>
                                                <small class="text-muted">
                                                    <%= new Date(activity.created_at).toLocaleDateString('en-IN', { 
                                                        year: 'numeric', 
                                                        month: 'short', 
                                                        day: 'numeric',
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    }) %>
                                                </small>
                                            </div>
                                            <p class="mb-0 text-muted">
                                                <small>Type: <%= activity.action_type ? activity.action_type.replace('_', ' ') : 'General' %></small>
                                            </p>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <div class="empty-state">
                                        <div class="empty-state-icon">
                                            <i class="fas fa-history"></i>
                                        </div>
                                        <h5>No recent activity found</h5>
                                        <p class="text-muted">Your recent activities will appear here.</p>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-key me-2"></i>Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/user_profile/change-password" id="passwordForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Current Password *</label>
                            <input type="password" class="form-control" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Password *</label>
                            <input type="password" class="form-control" name="new_password" required minlength="6">
                            <small class="text-muted">Minimum 6 characters</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirm New Password *</label>
                            <input type="password" class="form-control" name="confirm_password" required minlength="6">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update datetime every second
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('en-IN', options);
        }
        
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Initial call

        // Auto-hide alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    if (alert && alert.style) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            });

            // Handle profile picture preview
            const profilePictureInput = document.getElementById('profilePictureInput');
            const profilePicturePreview = document.getElementById('profilePicturePreview');
            
            if (profilePictureInput && profilePicturePreview) {
                profilePictureInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            profilePicturePreview.src = e.target.result;
                            profilePicturePreview.style.display = 'block';
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Handle existing profile picture error
            const profileAvatarImg = document.querySelector('.profile-avatar-img');
            if (profileAvatarImg) {
                profileAvatarImg.onerror = function() {
                    this.style.display = 'none';
                    const parent = this.parentElement;
                    parent.innerHTML = '<i class="fas fa-user"></i>';
                    parent.style.display = 'flex';
                    parent.style.alignItems = 'center';
                    parent.style.justifyContent = 'center';
                };
            }

            // Password form validation
            const passwordForm = document.getElementById('passwordForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', function(e) {
                    const newPassword = this.querySelector('input[name="new_password"]').value;
                    const confirmPassword = this.querySelector('input[name="confirm_password"]').value;
                    
                    if (newPassword !== confirmPassword) {
                        e.preventDefault();
                        alert('New passwords do not match!');
                        return false;
                    }
                    
                    if (newPassword.length < 6) {
                        e.preventDefault();
                        alert('Password must be at least 6 characters long!');
                        return false;
                    }
                    
                    return true;
                });
            }

            // Profile form validation
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    const phone = this.querySelector('input[name="phone"]').value;
                    const cnic = this.querySelector('input[name="cnic"]').value;
                    
                    if (phone && !/^\d{10,15}$/.test(phone)) {
                        e.preventDefault();
                        alert('Please enter a valid phone number (10-15 digits)!');
                        return false;
                    }
                    
                    if (cnic && !/^\d{13}$/.test(cnic)) {
                        e.preventDefault();
                        alert('Please enter a valid 13-digit CNIC!');
                        return false;
                    }
                    
                    return true;
                });
            }
        });

        // Function to switch tabs programmatically
        function switchTab(tabName) {
            const tabTrigger = document.querySelector(`#profileTabs a[href="#${tabName}"]`);
            if (tabTrigger) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();
            }
        }

        // Show success/error messages in URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('success') || urlParams.has('error')) {
            // Remove query parameters from URL without reloading
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
</body>
</html>