<!-- dashboard.ejs -->
<div class="dashboard-container">
  <!-- Welcome Header with Date/Time -->
  <div class="dashboard-header">
    <div>
      <h1>Welcome, <span class="username"><%= user.name %></span></h1>
      <p class="datetime" id="datetime"></p>
    </div>
    <div class="shop-info">
      <p><i class="fas fa-store"></i> <%= shop.name %></p>
      <p><i class="fas fa-map-marker-alt"></i> <%= shop.address %></p>
    </div>
  </div>

  <!-- Quick Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card bg-primary" onclick="window.location.href='/products'">
      <div class="stat-icon">
        <i class="fas fa-box-open"></i>
      </div>
      <div class="stat-info">
        <h3 id="totalProducts">Loading...</h3>
        <p>Total Products</p>
      </div>
      <div class="stat-trend">
        <i class="fas fa-arrow-up"></i> <span>5% from last month</span>
      </div>
    </div>

    <div class="stat-card bg-success" onclick="window.location.href='/sales'">
      <div class="stat-icon">
        <i class="fas fa-receipt"></i>
      </div>
      <div class="stat-info">
        <h3 id="todaySales">Loading...</h3>
        <p>Today's Sales</p>
      </div>
      <div class="stat-trend">
        <i class="fas fa-arrow-up"></i> <span>12% from yesterday</span>
      </div>
    </div>

    <div class="stat-card bg-warning" onclick="window.location.href='/employees'">
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-info">
        <h3 id="totalEmployees">Loading...</h3>
        <p>Employees</p>
      </div>
    </div>

    <div class="stat-card bg-danger" onclick="window.location.href='/inventory/alerts'">
      <div class="stat-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-info">
        <h3 id="lowStockItems">Loading...</h3>
        <p>Low Stock Items</p>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="dashboard-content">
    <!-- Left Column -->
    <div class="dashboard-left">
      <!-- Quick Actions -->
      <div class="quick-actions card">
        <div class="section-header">
          <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
        </div>
        <div class="action-grid">
          <a href="/products" class="action-card">
            <div class="action-icon bg-primary">
              <i class="fas fa-plus"></i>
            </div>
            <p>Add Product</p>
          </a>
          
          <a href="/bills" class="action-card">
            <div class="action-icon bg-success">
              <i class="fas fa-receipt"></i>
            </div>
            <p>Create Bill</p>
          </a>
          
          <a href="/customers" class="action-card">
            <div class="action-icon bg-info">
              <i class="fas fa-user-plus"></i>
            </div>
            <p>Add Customer</p>
          </a>
          
          <a href="/employees" class="action-card">
            <div class="action-icon bg-warning">
              <i class="fas fa-users"></i>
            </div>
            <p>Add Employee</p>
          </a>
          
          <a href="/reports" class="action-card">
            <div class="action-icon bg-secondary">
              <i class="fas fa-file-alt"></i>
            </div>
            <p>Daily Report</p>
          </a>
          
          <a href="/inventory" class="action-card">
            <div class="action-icon bg-dark">
              <i class="fas fa-warehouse"></i>
            </div>
            <p>Inventory</p>
          </a>
        </div>
      </div>

      <!-- Recent Sales -->
      <div class="recent-sales card">
        <div class="section-header">
          <h2><i class="fas fa-shopping-cart"></i> Recent Sales</h2>
          <a href="/sales" class="view-all">View All</a>
        </div>
        <div class="sales-list" id="recentSales">
          <!-- Will be populated by JavaScript -->
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> Loading recent sales...
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="dashboard-right">
      <!-- Low Stock Alert -->
      <div class="low-stock card">
        <div class="section-header">
          <h2><i class="fas fa-exclamation-triangle"></i> Low Stock Alerts</h2>
          <a href="/inventory/alerts" class="view-all">View All</a>
        </div>
        <div class="alert-table">
          <table class="table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Stock</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="lowStockTable">
              <!-- Will be populated by JavaScript -->
              <tr>
                <td colspan="3" class="text-center">
                  <i class="fas fa-spinner fa-spin"></i> Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="activity-section card">
        <div class="section-header">
          <h2><i class="fas fa-history"></i> Recent Activity</h2>
          <a href="/activity" class="view-all">View All</a>
        </div>
        <div class="activity-list" id="recentActivity">
          <!-- Will be populated by JavaScript -->
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> Loading activities...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Daily Summary Modal -->
  <div class="modal fade" id="dailySummaryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Daily Summary</h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body" id="dailySummaryContent">
          Loading daily summary...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="printDailySummary()">
            <i class="fas fa-print"></i> Print
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Dashboard Styles */
  :root {
    --primary: #4e73df;
    --success: #1cc88a;
    --warning: #f6c23e;
    --danger: #e74a3b;
    --info: #36b9cc;
    --secondary: #858796;
    --dark: #5a5c69;
    --light: #f8f9fc;
  }

  .dashboard-container {
    padding: 20px;
    background-color: #f5f7fa;
    min-height: calc(100vh - 70px);
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .dashboard-header h1 {
    font-size: 1.8rem;
    margin: 0;
    color: var(--dark);
  }

  .username {
    color: var(--primary);
  }

  .datetime {
    color: var(--secondary);
    font-size: 0.9rem;
    margin-top: 5px;
  }

  .shop-info {
    text-align: right;
  }

  .shop-info p {
    margin: 5px 0;
    color: var(--dark);
    font-size: 0.9rem;
  }

  .shop-info i {
    margin-right: 5px;
    color: var(--primary);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    display: flex;
    align-items: center;
    padding: 20px;
    border-radius: 10px;
    color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: transform 0.3s;
    position: relative;
    overflow: hidden;
  }

  .stat-card:hover {
    transform: translateY(-5px);
  }

  .stat-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .stat-card:hover::after {
    opacity: 1;
  }

  .stat-icon {
    font-size: 2rem;
    margin-right: 20px;
    z-index: 1;
  }

  .stat-info {
    z-index: 1;
  }

  .stat-info h3 {
    font-size: 1.8rem;
    margin: 0;
  }

  .stat-info p {
    margin: 5px 0 0;
    opacity: 0.9;
    font-size: 0.9rem;
  }

  .stat-trend {
    position: absolute;
    bottom: 10px;
    right: 15px;
    font-size: 0.7rem;
    opacity: 0.9;
    display: flex;
    align-items: center;
  }

  .stat-trend i {
    margin-right: 3px;
  }

  .dashboard-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  @media (max-width: 992px) {
    .dashboard-content {
      grid-template-columns: 1fr;
    }
  }

  .card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }

  .section-header h2 {
    font-size: 1.2rem;
    margin: 0;
    display: flex;
    align-items: center;
    color: var(--dark);
  }

  .section-header h2 i {
    margin-right: 10px;
    color: var(--primary);
  }

  .view-all {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.85rem;
  }

  .view-all:hover {
    text-decoration: underline;
  }

  /* Quick Actions */
  .action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
  }

  .action-card {
    background: white;
    border-radius: 8px;
    padding: 15px 10px;
    text-align: center;
    text-decoration: none;
    color: var(--dark);
    transition: all 0.3s;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    border: 1px solid #eee;
  }

  .action-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border-color: var(--primary);
    color: var(--primary);
  }

  .action-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-size: 1.2rem;
    color: white;
  }

  .action-card p {
    margin: 0;
    font-size: 0.85rem;
    font-weight: 500;
  }

  /* Recent Sales */
  .sales-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .sale-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .sale-item:last-child {
    border-bottom: none;
  }

  .sale-info {
    flex: 1;
  }

  .sale-info .sale-id {
    font-weight: 600;
    color: var(--dark);
    font-size: 0.9rem;
  }

  .sale-info .sale-time {
    font-size: 0.8rem;
    color: var(--secondary);
  }

  .sale-amount {
    font-weight: 600;
    color: var(--success);
  }

  /* Low Stock Table */
  .alert-table {
    max-height: 300px;
    overflow-y: auto;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table th {
    font-weight: 600;
    color: var(--secondary);
    font-size: 0.85rem;
    text-align: left;
    padding: 10px;
    background: #f8f9fc;
    position: sticky;
    top: 0;
  }

  .table td {
    padding: 10px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.9rem;
  }

  .table tr:last-child td {
    border-bottom: none;
  }

  .table tr:hover td {
    background-color: #f8f9fc;
  }

  /* Activity List */
  .activity-list {
    max-height: 300px;
    overflow-y: auto;
  }

  .activity-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #eee;
  }

  .activity-item:last-child {
    border-bottom: none;
  }

  .activity-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 0.9rem;
  }

  .activity-icon.success {
    background-color: rgba(40, 167, 69, 0.2);
    color: var(--success);
  }

  .activity-icon.primary {
    background-color: rgba(0, 123, 255, 0.2);
    color: var(--primary);
  }

  .activity-icon.warning {
    background-color: rgba(255, 193, 7, 0.2);
    color: var(--warning);
  }

  .activity-icon.danger {
    background-color: rgba(231, 74, 59, 0.2);
    color: var(--danger);
  }

  .activity-details {
    flex: 1;
  }

  .activity-details p {
    margin: 0;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .activity-time {
    font-size: 0.75rem;
    color: var(--secondary);
  }

  /* Loading Spinner */
  .loading-spinner {
    padding: 20px;
    text-align: center;
    color: var(--secondary);
  }

  .loading-spinner i {
    margin-right: 8px;
  }

  /* Color Classes */
  .bg-primary { background-color: var(--primary); }
  .bg-success { background-color: var(--success); }
  .bg-warning { background-color: var(--warning); }
  .bg-danger { background-color: var(--danger); }
  .bg-info { background-color: var(--info); }
  .bg-secondary { background-color: var(--secondary); }
  .bg-dark { background-color: var(--dark); }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 6px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  margin: 5px 0;
  background-clip: content-box;
  }

  ::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
</style>

<script>
  // Update datetime every second
  function updateDateTime() {
    const now = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    };
    document.getElementById('datetime').textContent = now.toLocaleDateString('en-IN', options);
  }
  
  setInterval(updateDateTime, 1000);
  updateDateTime(); // Initial call

  // Fetch dashboard data from API
  document.addEventListener('DOMContentLoaded', function() {
    fetchDashboardData();
    
    // Check if we should show daily summary modal (e.g., on first login of the day)
    const lastSummaryShown = localStorage.getItem('lastSummaryShown');
    const today = new Date().toDateString();
    
    if (!lastSummaryShown || lastSummaryShown !== today) {
      fetchDailySummary();
      localStorage.setItem('lastSummaryShown', today);
    }
  });

  function fetchDashboardData() {
    // Fetch stats
    fetch('/api/dashboard/stats')
      .then(response => response.json())
      .then(data => {
        document.getElementById('totalProducts').textContent = data.totalProducts.toLocaleString();
        document.getElementById('todaySales').textContent = '₹' + data.todaySales.toLocaleString('en-IN');
        document.getElementById('totalEmployees').textContent = data.totalEmployees;
        document.getElementById('lowStockItems').textContent = data.lowStockItems;
      })
      .catch(error => console.error('Error fetching stats:', error));

    // Fetch recent sales
    fetch('/api/dashboard/recent-sales')
      .then(response => response.json())
      .then(data => {
        const salesList = document.getElementById('recentSales');
        salesList.innerHTML = '';
        
        if (data.length === 0) {
          salesList.innerHTML = '<div class="text-center py-3 text-muted">No recent sales</div>';
          return;
        }
        
        data.forEach(sale => {
          const saleItem = document.createElement('div');
          saleItem.className = 'sale-item';
          saleItem.innerHTML = `
            <div class="sale-info">
              <div class="sale-id">Sale #${sale.id}</div>
              <div class="sale-time">${new Date(sale.createdAt).toLocaleTimeString()}</div>
            </div>
            <div class="sale-amount">₹${sale.totalAmount.toLocaleString('en-IN')}</div>
          `;
          saleItem.onclick = () => window.location.href = `/bills/${sale.id}`;
          salesList.appendChild(saleItem);
        });
      })
      .catch(error => console.error('Error fetching recent sales:', error));

    // Fetch low stock items
    fetch('/api/dashboard/low-stock')
      .then(response => response.json())
      .then(data => {
        const stockTable = document.getElementById('lowStockTable');
        stockTable.innerHTML = '';
        
        if (data.length === 0) {
          stockTable.innerHTML = `
            <tr>
              <td colspan="3" class="text-center py-3 text-muted">No low stock items</td>
            </tr>
          `;
          return;
        }
        
        data.forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.name}</td>
            <td><span class="badge badge-danger">${item.stock} left</span></td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="reorderProduct(${item.id})">
                <i class="fas fa-shopping-cart"></i> Reorder
              </button>
            </td>
          `;
          stockTable.appendChild(row);
        });
      })
      .catch(error => console.error('Error fetching low stock items:', error));

    // Fetch recent activity
    fetch('/api/dashboard/activity')
      .then(response => response.json())
      .then(data => {
        const activityList = document.getElementById('recentActivity');
        activityList.innerHTML = '';
        
        if (data.length === 0) {
          activityList.innerHTML = '<div class="text-center py-3 text-muted">No recent activity</div>';
          return;
        }
        
        data.forEach(activity => {
          let iconClass = 'primary';
          let icon = 'fa-info-circle';
          
          if (activity.type === 'sale') {
            iconClass = 'success';
            icon = 'fa-rupee-sign';
          } else if (activity.type === 'inventory') {
            iconClass = 'warning';
            icon = 'fa-box';
          } else if (activity.type === 'employee') {
            iconClass = 'info';
            icon = 'fa-user';
          } else if (activity.type === 'alert') {
            iconClass = 'danger';
            icon = 'fa-exclamation-triangle';
          }
          
          const activityItem = document.createElement('div');
          activityItem.className = 'activity-item';
          activityItem.innerHTML = `
            <div class="activity-icon ${iconClass}">
              <i class="fas ${icon}"></i>
            </div>
            <div class="activity-details">
              <p>${activity.description}</p>
              <span class="activity-time">${formatTimeAgo(activity.timestamp)}</span>
            </div>
          `;
          activityList.appendChild(activityItem);
        });
      })
      .catch(error => console.error('Error fetching activity:', error));
  }

  function formatTimeAgo(timestamp) {
    const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
    
    if (seconds < 60) return 'Just now';
    
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} min${minutes === 1 ? '' : 's'} ago`;
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
    
    const days = Math.floor(hours / 24);
    return `${days} day${days === 1 ? '' : 's'} ago`;
  }

  function reorderProduct(productId) {
    // Show reorder modal or directly add to purchase list
    console.log('Reorder product:', productId);
    // In a real app, you would implement this functionality
    alert(`Reorder requested for product ID: ${productId}`);
  }

  function fetchDailySummary() {
    fetch('/api/dashboard/daily-summary')
      .then(response => response.json())
      .then(data => {
        const modalContent = document.getElementById('dailySummaryContent');
        modalContent.innerHTML = `
          <div class="summary-item">
            <h5>Today's Sales</h5>
            <p>₹${data.todaySales.toLocaleString('en-IN')} from ${data.totalTransactions} transactions</p>
          </div>
          <div class="summary-item">
            <h5>Top Selling Products</h5>
            <ol>
              ${data.topProducts.map(p => `<li>${p.name} (${p.quantity} sold)</li>`).join('')}
            </ol>
          </div>
          <div class="summary-item">
            <h5>Inventory Alerts</h5>
            <p>${data.lowStockItems} items below minimum stock level</p>
          </div>
        `;
        
        // Show modal
        $('#dailySummaryModal').modal('show');
      })
      .catch(error => {
        console.error('Error fetching daily summary:', error);
        document.getElementById('dailySummaryContent').textContent = 'Could not load daily summary.';
      });
  }

  function printDailySummary() {
    // Implement print functionality
    window.print();
  }

  // Refresh data every 30 seconds
  setInterval(fetchDashboardData, 30000);
</script>