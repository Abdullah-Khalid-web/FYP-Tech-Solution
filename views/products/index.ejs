<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - <%= (shop && shop.name) || 'My Shop' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: <%= (shop && shop.primary_color) || '#007bff' %>;
            --secondary-color: <%= (shop && shop.secondary_color) || '#6c757d' %>;
            --info-color: #0dcaf0;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-header {
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1.5rem 0;
            margin-bottom: 1.5rem;
        }

        /* Enhanced Quick Stats Styles */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            border-radius: 0 1rem 0 0;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .stat-card.products {
            border-left-color: var(--info-color);
        }

        .stat-card.stock {
            border-left-color: var(--success-color);
        }

        .stat-card.investment {
            border-left-color: var(--warning-color);
        }

        .stat-card.low-stock {
            border-left-color: var(--danger-color);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-card.products .stat-icon {
            background-color: rgba(13, 202, 240, 0.1);
            color: var(--info-color);
        }

        .stat-card.stock .stat-icon {
            background-color: rgba(25, 135, 84, 0.1);
            color: var(--success-color);
        }

        .stat-card.investment .stat-icon {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
        }

        .stat-card.low-stock .stat-icon {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
            line-height: 1;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            margin-top: 0.75rem;
        }

        .trend-up {
            color: var(--success-color);
        }

        .trend-down {
            color: var(--danger-color);
        }

        .trend-neutral {
            color: var(--secondary-color);
        }

        .trend-icon {
            margin-right: 0.25rem;
            font-size: 0.75rem;
        }

        .stat-details {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }

        .stat-card-footer {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-action {
            font-size: 0.8rem;
            color: var(--primary-color);
            cursor: pointer;
            transition: color 0.2s;
        }

        .stat-action:hover {
            color: #1e429f;
        }

        .stat-progress {
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .stat-progress-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .stat-card.products .stat-progress-bar {
            background-color: var(--info-color);
        }

        .stat-card.stock .stat-progress-bar {
            background-color: var(--success-color);
        }

        .stat-card.investment .stat-progress-bar {
            background-color: var(--warning-color);
        }

        .stat-card.low-stock .stat-progress-bar {
            background-color: var(--danger-color);
        }

        /* Loading animation for stats */
        .stat-loading {
            position: relative;
            overflow: hidden;
        }

        .stat-loading::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.25rem;
            }
            
            .stat-value {
                font-size: 1.75rem;
            }
        }

        /* Rest of your existing CSS styles... */
    </style>
</head>

<body data-shop-currency="<%= (shop && shop.currency) || 'PKR' %>">
    <!-- Shop data for JavaScript -->
    <script>
        window.shopData = {
            currency: '<%= (shop && shop.currency) || "PKR" %>',
            name: '<%= (shop && shop.name) || "My Shop" %>',
            primaryColor: '<%= (shop && shop.primary_color) || "#007bff" %>',
            secondaryColor: '<%= (shop && shop.secondary_color) || "#6c757d" %>'
        };
    </script>

    <!-- Header -->
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-2"><i class="fas fa-boxes me-2"></i>Product Management</h1>
                    <p class="mb-0 text-muted">Manage your inventory efficiently</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="/" class="btn btn-outline btn-sm me-2">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                        <i class="fas fa-plus me-2"></i>Add Product
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Enhanced Quick Stats -->
        <div class="stats-container" id="quickStats">
            <div class="stat-card products">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-label">Total Products</div>
                        <div class="stat-value" id="totalProducts">0</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-box"></i>
                    </div>
                </div>
                <div class="stat-trend">
                    <span class="trend-neutral" id="productsTrend">
                        <i class="fas fa-minus trend-icon"></i>
                        <span>No change</span>
                    </span>
                </div>
                <div class="stat-details" id="productsDetails">Active in inventory</div>
                <div class="stat-progress">
                    <div class="stat-progress-bar" id="productsProgress" style="width: 0%"></div>
                </div>
                <div class="stat-card-footer">
                    <span id="productsStatus">Loading...</span>
                    <span class="stat-action" onclick="refreshStats()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </span>
                </div>
            </div>
            
            <div class="stat-card stock">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-label">Total Stock</div>
                        <div class="stat-value" id="totalStock">0</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-cubes"></i>
                    </div>
                </div>
                <div class="stat-trend">
                    <span class="trend-neutral" id="stockTrend">
                        <i class="fas fa-minus trend-icon"></i>
                        <span>No change</span>
                    </span>
                </div>
                <div class="stat-details" id="stockDetails">Units available</div>
                <div class="stat-progress">
                    <div class="stat-progress-bar" id="stockProgress" style="width: 0%"></div>
                </div>
                <div class="stat-card-footer">
                    <span id="stockStatus">Loading...</span>
                    <span class="stat-action" onclick="viewStockAlerts()">
                        <i class="fas fa-chart-bar me-1"></i>View Details
                    </span>
                </div>
            </div>
            
            <div class="stat-card investment">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-label">Total Investment</div>
                        <div class="stat-value" id="totalInvestment">â‚¨0</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <div class="stat-trend">
                    <span class="trend-neutral" id="investmentTrend">
                        <i class="fas fa-minus trend-icon"></i>
                        <span>No change</span>
                    </span>
                </div>
                <div class="stat-details" id="investmentDetails">In inventory</div>
                <div class="stat-progress">
                    <div class="stat-progress-bar" id="investmentProgress" style="width: 0%"></div>
                </div>
                <div class="stat-card-footer">
                    <span id="investmentStatus">Loading...</span>
                    <span class="stat-action" onclick="viewInvestmentReport()">
                        <i class="fas fa-chart-line me-1"></i>View Report
                    </span>
                </div>
            </div>
            
            <div class="stat-card low-stock">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-label">Low Stock</div>
                        <div class="stat-value" id="lowStockCount">0</div>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="stat-trend">
                    <span class="trend-neutral" id="lowStockTrend">
                        <i class="fas fa-minus trend-icon"></i>
                        <span>No change</span>
                    </span>
                </div>
                <div class="stat-details" id="lowStockDetails">Need restocking</div>
                <div class="stat-progress">
                    <div class="stat-progress-bar" id="lowStockProgress" style="width: 0%"></div>
                </div>
                <div class="stat-card-footer">
                    <span id="lowStockStatus">Loading...</span>
                    <span class="stat-action" onclick="viewStockAlerts()">
                        <i class="fas fa-bell me-1"></i>View Alerts
                    </span>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Products</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="productSearch" class="form-control" placeholder="Search products...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="categoryFilter" class="form-select">
                            <option value="">All Categories</option>
                            <% if (categories && categories.length) { %>
                                <% categories.forEach(category=> { %>
                                    <option value="<%= category %>">
                                        <%= category %>
                                    </option>
                                    <% }); %>
                                        <% } %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="statusFilter" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button id="resetFilters" class="btn btn-outline w-100">
                            <i class="fas fa-sync-alt me-1"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <!-- Products Table -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Products</h5>
                    <span class="badge bg-primary badge-pill">
                        <%= products && products.length ? products.length : '0' %> products
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="productsTable">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Image</th>
                                <th>Name</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Buying Price</th>
                                <th>Selling Price</th>
                                <th>Suppliers</th> <!-- Add this column -->
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (products && products.length) { %>
                                <% products.forEach(product=> { %>
                                    <tr data-product-id="<%= product.id %>"
                                        data-category="<%= product.category || '' %>"
                                        data-status="<%= product.status %>">
                                        <td>
                                            <%= product.id %>
                                        </td>
                                        <td>
                                            <% if (product.image) { %>
                                                <img src="/uploads/<%= product.image %>" alt="<%= product.name %>"
                                                    class="img-thumbnail"
                                                    style="width: 50px; height: 50px; object-fit: cover;">
                                                <% } else { %>
                                                    <div class="no-image-placeholder"
                                                        style="width: 50px; height: 50px; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem;">
                                                        <i class="fas fa-box-open text-muted"></i>
                                                    </div>
                                                    <% } %>
                                        </td>
                                        <td data-brand="<%= product.brand || '' %>">
                                            <div class="fw-semibold">
                                                <%= product.name %>
                                            </div>
                                            <% if (product.brand) { %>
                                                <small class="text-muted">
                                                    <%= product.brand %>
                                                </small>
                                                <% } %>
                                        </td>
                                        <td>
                                            <%= product.sku || 'N/A' %>
                                        </td>
                                        <td data-size="<%= product.size || '' %>">
                                            <%= product.category || 'Uncategorized' %>
                                        </td>
                                        <td>
                                            <span
                                                class="badge <%= product.quantity <= product.min_stock_alert ? 'bg-warning' : 'bg-success' %>">
                                                <%= product.quantity %>
                                                    <% if (product.quantity <=product.min_stock_alert) { %>
                                                        <i class="fas fa-exclamation-triangle ms-1"></i>
                                                        <% } %>
                                            </span>
                                        </td>
                                        <td>
                                            <%= Number(product.buying_price || 0).toFixed(2) %>
                                        </td>
                                        <td>
                                            <%= Number(product.selling_price || 0).toFixed(2) %>
                                        </td>
                                        <td>
                                            <span class="badge bg-info badge-pill">
                                                <%= product.supplier_count || 0 %>
                                            </span>
                                        </td>
                                        <td>
                                            <span
                                                class="badge <%= product.status === 'active' ? 'bg-success' : 'bg-secondary' %>">
                                                <%= product.status.charAt(0).toUpperCase() + product.status.slice(1) %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-primary edit-product"
                                                    data-bs-toggle="tooltip" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-success add-stock"
                                                    data-bs-toggle="tooltip" title="Add Stock">
                                                    <i class="fas fa-plus-circle"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary toggle-status"
                                                    data-bs-toggle="tooltip"
                                                    title="<%= product.status === 'active' ? 'Deactivate' : 'Activate' %>">
                                                    <i
                                                        class="fas <%= product.status === 'active' ? 'fa-toggle-on' : 'fa-toggle-off' %>"></i>
                                                </button>
                                                <!-- In the actions button group, add this button after the existing ones -->
                                                <button class="btn btn-outline-info manage-suppliers"
                                                    data-bs-toggle="tooltip" title="Manage Suppliers">
                                                    <i class="fas fa-truck"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }); %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="10" class="text-center py-4">
                                                    <div class="empty-state">
                                                        <div class="empty-state-icon">
                                                            <i class="fas fa-box-open"></i>
                                                        </div>
                                                        <h5>No products found</h5>
                                                        <p class="text-muted mb-3">Add your first product to get started
                                                        </p>
                                                        <button class="btn btn-primary" data-bs-toggle="modal"
                                                            data-bs-target="#addProductModal">
                                                            <i class="fas fa-plus me-2"></i>Add Product
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <% } %>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <% if (totalPages> 1) { %>
                    <div class="card-header border-top">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                    <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <% for (let i=1; i <=totalPages; i++) { %>
                                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                        <a class="page-link" href="?page=<%= i %>">
                                            <%= i %>
                                        </a>
                                    </li>
                                    <% } %>
                                        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                            <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                            </ul>
                        </nav>
                    </div>
                    <% } %>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addProductForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="productName" name="name" required>
                                </div>

                                <!-- ADD SUPPLIER FIELD -->
                                <div class="mb-3">
                                    <label for="productSupplier" class="form-label">Supplier</label>
                                    <select class="form-select" id="productSupplier" name="supplier_id">
                                        <option value="">Select Supplier</option>
                                        <!-- Suppliers will be loaded dynamically -->
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="productBrand" class="form-label">Brand</label>
                                    <input type="text" class="form-control" id="productBrand" name="brand">
                                </div>
                                <div class="mb-3">
                                    <label for="productCategory" class="form-label">Category</label>
                                    <input type="text" class="form-control" id="productCategory" name="category"
                                        list="categoryList">
                                    <datalist id="categoryList">
                                        <% if (categories && categories.length) { %>
                                            <% categories.forEach(category=> { %>
                                                <option value="<%= category %>">
                                                    <% }); %>
                                                        <% } %>
                                    </datalist>
                                </div>
                                <div class="mb-3">
                                    <label for="productSize" class="form-label">Size</label>
                                    <input type="text" class="form-control" id="productSize" name="size">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productImage" class="form-label">Product Image</label>
                                    <input type="file" class="form-control" id="productImage" name="image"
                                        accept="image/*">
                                    <div class="mt-2" id="imagePreviewContainer" style="display: none;">
                                        <img id="imagePreview" src="#" alt="Preview"
                                            style="max-height: 150px; max-width: 100%; border-radius: 0.375rem;">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="productSKU" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="productSKU" name="sku">
                                </div>
                                <div class="mb-3">
                                    <label for="productBarcode" class="form-label">Barcode</label>
                                    <input type="text" class="form-control" id="productBarcode" name="barcode">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="buyingPrice" class="form-label">Buying Price *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <%= (shop && shop.currency) || 'PKR' %>
                                        </span>
                                        <input type="number" step="0.01" class="form-control" id="buyingPrice"
                                            name="buying_price" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sellingPrice" class="form-label">Selling Price *</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <%= (shop && shop.currency) || 'PKR' %>
                                        </span>
                                        <input type="number" step="0.01" class="form-control" id="sellingPrice"
                                            name="selling_price" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="taxPercent" class="form-label">Tax (%)</label>
                                    <input type="number" step="0.01" class="form-control" id="taxPercent"
                                        name="tax_percent" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="initialQuantity" class="form-label">Initial Quantity *</label>
                                    <input type="number" class="form-control" id="initialQuantity" name="quantity"
                                        value="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="minStockAlert" class="form-label">Low Stock Alert Level</label>
                                    <input type="number" class="form-control" id="minStockAlert" name="min_stock_alert"
                                        value="5">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editProductForm" enctype="multipart/form-data">
                    <input type="hidden" id="editProductId" name="id">
                    <div class="modal-body">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading product details...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal fade" id="addStockModal" tabindex="-1" aria-labelledby="addStockModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStockModalLabel">Add Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addStockForm">
                    <input type="hidden" id="stockProductId" name="product_id">
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h5 id="stockProductName"></h5>
                                <div class="row small text-muted">
                                    <div class="col-md-3">
                                        <strong>Brand:</strong> <span id="stockProductBrand"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Category:</strong> <span id="stockProductCategory"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Size:</strong> <span id="stockProductSize"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>SKU:</strong> <span id="stockProductSku"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-flex align-items-center justify-content-end">
                                    <span class="me-2">Current Stock:</span>
                                    <span class="badge bg-primary badge-pill" id="currentStockBadge">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Current Prices</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Buying Price</label>
                                                <div class="input-group mb-3">
                                                    <span class="input-group-text">
                                                        <%= (shop && shop.currency) || 'PKR' %>
                                                    </span>
                                                    <input type="text" class="form-control" id="currentBuyingPrice"
                                                        readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Selling Price</label>
                                                <div class="input-group mb-3">
                                                    <span class="input-group-text">
                                                        <%= (shop && shop.currency) || 'PKR' %>
                                                    </span>
                                                    <input type="text" class="form-control" id="currentSellingPrice"
                                                        readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Update Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="quantityToAdd" class="form-label">Quantity to Add *</label>
                                            <input type="number" class="form-control" id="quantityToAdd" name="quantity"
                                                min="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newBuyingPrice" class="form-label">New Buying Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <%= (shop && shop.currency) || 'PKR' %>
                                                </span>
                                                <input type="number" step="0.01" class="form-control"
                                                    id="newBuyingPrice" name="buying_price">
                                            </div>
                                            <small class="text-muted">Leave blank to keep current price</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="newSellingPrice" class="form-label">New Selling Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <%= (shop && shop.currency) || 'PKR' %>
                                                </span>
                                                <input type="number" step="0.01" class="form-control"
                                                    id="newSellingPrice" name="selling_price">
                                            </div>
                                            <small class="text-muted">Leave blank to keep current price</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Stock & Prices</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Manage Suppliers Modal -->
    <div class="modal fade" id="manageSuppliersModal" tabindex="-1" aria-labelledby="manageSuppliersModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageSuppliersModalLabel">Manage Product Suppliers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading product suppliers...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Helper function to get shop currency
        function getShopCurrency() {
            if (window.shopData && window.shopData.currency) {
                return window.shopData.currency;
            }
            const currencyElement = document.querySelector('[data-shop-currency]');
            if (currencyElement) {
                return currencyElement.getAttribute('data-shop-currency');
            }
            const bodyCurrency = document.body.getAttribute('data-shop-currency');
            if (bodyCurrency) {
                return bodyCurrency;
            }
            return 'PKR';
        }

        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            alert(`${type.toUpperCase()}: ${message}`);
        }

        // Function to load suppliers for dropdown
        function loadSuppliers() {
            console.log('Loading suppliers...');
            return fetch('/products/suppliers/list')
                .then(response => {
                    console.log('Suppliers response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Suppliers data received:', data);
                    if (data.success) {
                        const supplierSelect = document.getElementById('productSupplier');
                        if (!supplierSelect) {
                            console.error('Supplier select element not found!');
                            return false;
                        }

                        // Clear existing options except the first one
                        while (supplierSelect.options.length > 1) {
                            supplierSelect.remove(1);
                        }

                        // Add suppliers to dropdown
                        data.suppliers.forEach(supplier => {
                            const option = document.createElement('option');
                            option.value = supplier.id;
                            option.textContent = `${supplier.name} ${supplier.contact_person ? `- ${supplier.contact_person}` : ''}`;
                            supplierSelect.appendChild(option);
                        });

                        console.log(`Loaded ${data.suppliers.length} suppliers`);
                        return true;
                    } else {
                        throw new Error(data.message || 'Failed to load suppliers');
                    }
                })
                .catch(error => {
                    console.error('Error loading suppliers:', error);
                    showToast('Error loading suppliers list: ' + error.message, 'error');
                    return false;
                });
        }

        // Function to load suppliers for edit form
        function loadSuppliersForEdit() {
            return fetch('/products/suppliers/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const supplierSelect = document.getElementById('editProductSupplier');
                        if (!supplierSelect) return false;

                        // Clear existing options except the first one
                        while (supplierSelect.options.length > 1) {
                            supplierSelect.remove(1);
                        }

                        // Add suppliers to dropdown
                        data.suppliers.forEach(supplier => {
                            const option = document.createElement('option');
                            option.value = supplier.id;
                            option.textContent = `${supplier.name} ${supplier.contact_person ? `- ${supplier.contact_person}` : ''}`;
                            supplierSelect.appendChild(option);
                        });

                        return true;
                    } else {
                        throw new Error(data.message || 'Failed to load suppliers');
                    }
                })
                .catch(error => {
                    console.error('Error loading suppliers for edit:', error);
                    return false;
                });
        }

        // Load product for editing
        function loadProductForEdit(productId) {
            const editModalBody = document.querySelector('#editProductModal .modal-body');
            editModalBody.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading product details...</p>
            </div>
        `;

            $('#editProductModal').modal('show');

            fetch(`/products/${productId}/edit`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.product) {
                        const product = data.product;
                        renderEditForm(product);
                    } else {
                        throw new Error(data.message || 'Error loading product');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    editModalBody.innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load product: ${error.message}
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" onclick="loadProductForEdit('${productId}')">
                            <i class="fas fa-sync-alt me-2"></i>Try Again
                        </button>
                    </div>
                `;
                });
        }

        // Render edit form
        function renderEditForm(product) {
            const editModalBody = document.querySelector('#editProductModal .modal-body');
            const currency = getShopCurrency();

            editModalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="editProductName" class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="editProductName" name="name" value="${escapeHtml(product.name || '')}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProductSupplier" class="form-label">Supplier</label>
                        <select class="form-select" id="editProductSupplier" name="supplier_id">
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editProductBrand" class="form-label">Brand</label>
                        <input type="text" class="form-control" id="editProductBrand" name="brand" value="${escapeHtml(product.brand || '')}">
                    </div>
                    <div class="mb-3">
                        <label for="editProductCategory" class="form-label">Category</label>
                        <input type="text" class="form-control" id="editProductCategory" name="category" value="${escapeHtml(product.category || '')}" list="categoryList">
                    </div>
                    <div class="mb-3">
                        <label for="editProductSize" class="form-label">Size</label>
                        <input type="text" class="form-control" id="editProductSize" name="size" value="${escapeHtml(product.size || '')}">
                    </div>
                    <div class="mb-3">
                        <label for="editMinStockAlert" class="form-label">Low Stock Alert Level</label>
                        <input type="number" class="form-control" id="editMinStockAlert" name="min_stock_alert" value="${product.min_stock_alert || 5}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="editProductImage" class="form-label">Product Image</label>
                        <input type="file" class="form-control" id="editProductImage" name="image" accept="image/*">
                        ${product.image ? `
                            <div class="mt-2">
                                <img src="/uploads/${escapeHtml(product.image)}" alt="Current Image" style="max-height: 150px; max-width: 100%; border-radius: 0.375rem;">
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="removeImage" name="remove_image">
                                    <label class="form-check-label" for="removeImage">Remove current image</label>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="mb-3">
                        <label for="editProductSKU" class="form-label">SKU</label>
                        <input type="text" class="form-control" id="editProductSKU" name="sku" value="${escapeHtml(product.sku || '')}">
                    </div>
                    <div class="mb-3">
                        <label for="editProductBarcode" class="form-label">Barcode</label>
                        <input type="text" class="form-control" id="editProductBarcode" name="barcode" value="${escapeHtml(product.barcode || '')}">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="editBuyingPrice" class="form-label">Buying Price *</label>
                        <div class="input-group">
                            <span class="input-group-text">${currency}</span>
                            <input type="number" step="0.01" class="form-control" id="editBuyingPrice" name="buying_price" value="${Number(product.buying_price || 0).toFixed(2)}" required>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="editSellingPrice" class="form-label">Selling Price *</label>
                        <div class="input-group">
                            <span class="input-group-text">${currency}</span>
                            <input type="number" step="0.01" class="form-control" id="editSellingPrice" name="selling_price" value="${Number(product.selling_price || 0).toFixed(2)}" required>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="editTaxPercent" class="form-label">Tax (%)</label>
                        <input type="number" step="0.01" class="form-control" id="editTaxPercent" name="tax_percent" value="${product.tax_percent || 0}">
                    </div>
                </div>
            </div>
        `;

            // Set the product ID in the hidden field
            document.getElementById('editProductId').value = product.id;

            // Load suppliers and set the selected one
            loadSuppliersForEdit().then(() => {
                if (product.supplier_id) {
                    const supplierSelect = document.getElementById('editProductSupplier');
                    supplierSelect.value = product.supplier_id;
                }
            });

            // Initialize image preview for edit form
            document.getElementById('editProductImage')?.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const previewContainer = document.createElement('div');
                        previewContainer.className = 'mt-2';
                        previewContainer.innerHTML = `<img src="${event.target.result}" alt="Preview" style="max-height: 150px; max-width: 100%; border-radius: 0.375rem;">`;
                        this.parentNode.appendChild(previewContainer);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Toggle product status
        function toggleProductStatus(productId) {
            if (!confirm('Are you sure you want to change the status of this product?')) return;

            fetch(`/products/${productId}/toggle-status`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Product status updated successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast(data.message || 'Error updating status', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred', 'error');
                });
        }

        // Filter products
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();

            let visibleCount = 0;

            document.querySelectorAll('#productsTable tbody tr[data-product-id]').forEach(row => {
                if (!row.getAttribute('data-product-id')) return;

                const name = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const sku = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                const category = row.getAttribute('data-category') ? row.getAttribute('data-category').toLowerCase() : '';
                const status = row.getAttribute('data-status') ? row.getAttribute('data-status').toLowerCase() : '';

                const matchesSearch = searchTerm === '' ||
                    name.includes(searchTerm) ||
                    sku.includes(searchTerm);

                const matchesCategory = categoryFilter === '' ||
                    (categoryFilter && category === categoryFilter) ||
                    (categoryFilter === '' && category === '');

                let statusMatch = true;
                if (statusFilter !== '') {
                    if (statusFilter === 'active') {
                        statusMatch = status === 'active';
                    } else if (statusFilter === 'inactive') {
                        statusMatch = status === 'inactive';
                    }
                }

                const shouldShow = matchesSearch && matchesCategory && statusMatch;
                row.style.display = shouldShow ? '' : 'none';

                if (shouldShow) {
                    visibleCount++;
                }
            });

            const noProductsRow = document.querySelector('#productsTable tbody tr:not([data-product-id])');
            if (noProductsRow) {
                noProductsRow.style.display = visibleCount === 0 ? '' : 'none';
            }

            const countBadge = document.querySelector('.card-header .badge');
            if (countBadge) {
                countBadge.textContent = `${visibleCount} products`;
            }
        }

        // Load product suppliers
        function loadProductSuppliers(productId) {
            const modalBody = document.querySelector('#manageSuppliersModal .modal-body');
            modalBody.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading product suppliers...</p>
            </div>
        `;

            $('#manageSuppliersModal').modal('show');

            fetch(`/products/${productId}/suppliers`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderProductSuppliers(productId, data.suppliers, data.availableSuppliers);
                    } else {
                        throw new Error(data.message || 'Error loading suppliers');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        Failed to load product suppliers: ${error.message}
                    </div>
                `;
                });
        }

        // Render product suppliers
        function renderProductSuppliers(productId, suppliers, availableSuppliers) {
            const modalBody = document.querySelector('#manageSuppliersModal .modal-body');
            const currency = window.shopData?.currency || 'PKR';

            modalBody.innerHTML = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h5>Manage Product Suppliers</h5>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                        <i class="fas fa-plus me-1"></i>Add Supplier
                    </button>
                </div>
            </div>

            <!-- Current Suppliers -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Current Suppliers (${suppliers.length})</h6>
                </div>
                <div class="card-body">
                    ${suppliers.length > 0 ? `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Supplier</th>
                                        <th>Contact</th>
                                        <th>Supplier SKU</th>
                                        <th>Supplier Price</th>
                                        <th>Min Order Qty</th>
                                        <th>Lead Time (Days)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${suppliers.map(supplier => `
                                        <tr data-supplier-id="${supplier.supplier_id}">
                                            <td>
                                                <div class="fw-semibold">${escapeHtml(supplier.supplier_name)}</div>
                                                ${supplier.contact_person ? `<small class="text-muted">${escapeHtml(supplier.contact_person)}</small>` : ''}
                                            </td>
                                            <td>
                                                <div class="contact-info small">
                                                    ${supplier.email ? `<div><i class="fas fa-envelope me-1"></i>${escapeHtml(supplier.email)}</div>` : ''}
                                                    ${supplier.phone ? `<div><i class="fas fa-phone me-1"></i>${escapeHtml(supplier.phone)}</div>` : ''}
                                                </div>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm supplier-sku" 
                                                       value="${escapeHtml(supplier.supplier_sku || '')}" 
                                                       placeholder="Supplier SKU">
                                            </td>
                                            <td>
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text">${currency}</span>
                                                    <input type="number" step="0.01" class="form-control supplier-price" 
                                                           value="${supplier.supplier_price || ''}">
                                                </div>
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm min-order-qty" 
                                                       value="${supplier.min_order_quantity || 1}" min="1">
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm lead-time" 
                                                       value="${supplier.lead_time_days || ''}" placeholder="Days">
                                            </td>
                                            <td>
                                                <button class="btn btn-success btn-sm update-supplier" title="Update">
                                                    <i class="fas fa-save"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm remove-supplier" title="Remove">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="text-center py-3">
                            <p class="text-muted">No suppliers added for this product yet.</p>
                        </div>
                    `}
                </div>
            </div>
        `;

            // Add event listeners for supplier management
            modalBody.querySelectorAll('.update-supplier').forEach(button => {
                button.addEventListener('click', function () {
                    const row = this.closest('tr');
                    const supplierId = row.getAttribute('data-supplier-id');
                    updateProductSupplier(productId, supplierId, row);
                });
            });

            modalBody.querySelectorAll('.remove-supplier').forEach(button => {
                button.addEventListener('click', function () {
                    const row = this.closest('tr');
                    const supplierId = row.getAttribute('data-supplier-id');
                    removeProductSupplier(productId, supplierId);
                });
            });

            // Add supplier modal content
            const addSupplierModal = document.createElement('div');
            addSupplierModal.className = 'modal fade';
            addSupplierModal.id = 'addSupplierModal';
            addSupplierModal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Supplier to Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="addSupplierForm">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="supplierSelect" class="form-label">Select Supplier</label>
                                <select class="form-select" id="supplierSelect" name="supplier_id" required>
                                    <option value="">Choose a supplier...</option>
                                    ${availableSuppliers.map(supplier => `
                                        <option value="${supplier.id}">
                                            ${escapeHtml(supplier.name)} ${supplier.contact_person ? `- ${escapeHtml(supplier.contact_person)}` : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="newSupplierSku" class="form-label">Supplier SKU</label>
                                <input type="text" class="form-control" id="newSupplierSku" name="supplier_sku">
                            </div>
                            <div class="mb-3">
                                <label for="newSupplierPrice" class="form-label">Supplier Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">${currency}</span>
                                    <input type="number" step="0.01" class="form-control" id="newSupplierPrice" name="supplier_price">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="newMinOrderQty" class="form-label">Min Order Quantity</label>
                                        <input type="number" class="form-control" id="newMinOrderQty" name="min_order_quantity" value="1" min="1">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="newLeadTime" class="form-label">Lead Time (Days)</label>
                                        <input type="number" class="form-control" id="newLeadTime" name="lead_time_days" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Supplier</button>
                        </div>
                    </form>
                </div>
            </div>
        `;

            document.body.appendChild(addSupplierModal);

            // Add supplier form submission
            document.getElementById('addSupplierForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);

                fetch(`/products/${productId}/suppliers`, {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Supplier added to product successfully!', 'success');
                            $('#addSupplierModal').modal('hide');
                            loadProductSuppliers(productId);
                        } else {
                            showToast(data.message || 'Error adding supplier', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred', 'error');
                    });
            });
        }

        // Update product supplier
        function updateProductSupplier(productId, supplierId, row) {
            const formData = new URLSearchParams();
            formData.append('supplier_sku', row.querySelector('.supplier-sku').value);
            formData.append('supplier_price', row.querySelector('.supplier-price').value);
            formData.append('min_order_quantity', row.querySelector('.min-order-qty').value);
            formData.append('lead_time_days', row.querySelector('.lead-time').value);

            fetch(`/products/${productId}/suppliers/${supplierId}`, {
                method: 'PUT',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Supplier updated successfully!', 'success');
                    } else {
                        showToast(data.message || 'Error updating supplier', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred', 'error');
                });
        }

        // Remove product supplier
        function removeProductSupplier(productId, supplierId) {
            if (!confirm('Are you sure you want to remove this supplier from the product?')) return;

            fetch(`/products/${productId}/suppliers/${supplierId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Supplier removed from product successfully!', 'success');
                        loadProductSuppliers(productId);
                    } else {
                        showToast(data.message || 'Error removing supplier', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred', 'error');
                });
        }

        // Enhanced filter function with debouncing
        let filterTimeout;
        function debounceFilter() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(filterProducts, 300);
        }

        // Main DOM content loaded - SINGLE EVENT LISTENER
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded - initializing product management');

            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Load suppliers when page loads
            loadSuppliers();

            // Load suppliers when add product modal opens
            document.getElementById('addProductModal').addEventListener('show.bs.modal', function () {
                console.log('Add product modal opened - loading suppliers');
                loadSuppliers();
            });

            // Image preview for add product form
            document.getElementById('productImage').addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        document.getElementById('imagePreview').src = event.target.result;
                        document.getElementById('imagePreviewContainer').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    document.getElementById('imagePreviewContainer').style.display = 'none';
                }
            });

            // Handle add product form submission
            document.getElementById('addProductForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);

                fetch('/products', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Product added successfully!', 'success');
                            $('#addProductModal').modal('hide');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast(data.message || 'Error adding product', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred', 'error');
                    });
            });

            // Handle edit product form submission
            document.getElementById('editProductForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const productId = document.getElementById('editProductId').value;

                fetch(`/products/${productId}`, {
                    method: 'PUT',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Product updated successfully!', 'success');
                            $('#editProductModal').modal('hide');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast(data.message || 'Error updating product', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred', 'error');
                    });
            });

            // Handle edit product clicks
            document.querySelectorAll('.edit-product').forEach(button => {
                button.addEventListener('click', function () {
                    const productId = this.closest('tr').getAttribute('data-product-id');
                    loadProductForEdit(productId);
                });
            });

            // Handle add stock form submission
            document.getElementById('addStockForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);

                const newSellingPrice = document.getElementById('newSellingPrice').value;
                if (newSellingPrice) {
                    formData.append('selling_price', newSellingPrice);
                }

                fetch('/products/add-stock', {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Stock and prices updated successfully!', 'success');
                            $('#addStockModal').modal('hide');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast(data.message || 'Error updating stock', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred', 'error');
                    });
            });

            // Handle manage suppliers clicks
            document.querySelectorAll('.manage-suppliers').forEach(button => {
                button.addEventListener('click', function () {
                    const productId = this.closest('tr').getAttribute('data-product-id');
                    loadProductSuppliers(productId);
                });
            });

            // Handle add stock clicks
            document.querySelectorAll('.add-stock').forEach(button => {
                button.addEventListener('click', function () {
                    const row = this.closest('tr');
                    const productId = row.getAttribute('data-product-id');

                    const productData = {
                        id: productId,
                        name: row.querySelector('td:nth-child(3)').textContent.trim(),
                        brand: row.querySelector('td:nth-child(3)').getAttribute('data-brand') || '',
                        category: row.getAttribute('data-category') || '',
                        size: row.querySelector('td:nth-child(5)').getAttribute('data-size') || '',
                        sku: row.querySelector('td:nth-child(4)').textContent.trim(),
                        currentStock: row.querySelector('td:nth-child(6)').textContent.trim(),
                        buyingPrice: row.querySelector('td:nth-child(7)').textContent.trim(),
                        sellingPrice: row.querySelector('td:nth-child(8)').textContent.trim()
                    };

                    document.getElementById('stockProductId').value = productId;
                    document.getElementById('stockProductName').textContent = productData.name;
                    document.getElementById('stockProductBrand').textContent = productData.brand || 'N/A';
                    document.getElementById('stockProductCategory').textContent = productData.category || 'N/A';
                    document.getElementById('stockProductSize').textContent = productData.size || 'N/A';
                    document.getElementById('stockProductSku').textContent = productData.sku || 'N/A';
                    document.getElementById('currentStockBadge').textContent = productData.currentStock;
                    document.getElementById('currentBuyingPrice').value = productData.buyingPrice;
                    document.getElementById('currentSellingPrice').value = productData.sellingPrice;

                    document.getElementById('quantityToAdd').value = '';
                    document.getElementById('newBuyingPrice').value = '';
                    document.getElementById('newSellingPrice').value = '';

                    $('#addStockModal').modal('show');
                });
            });

            // Handle toggle status clicks
            document.querySelectorAll('.toggle-status').forEach(button => {
                button.addEventListener('click', function () {
                    const productId = this.closest('tr').getAttribute('data-product-id');
                    toggleProductStatus(productId);
                });
            });

            // Search functionality with debouncing
            document.getElementById('productSearch').addEventListener('input', function () {
                debounceFilter();
            });

            // Filter functionality
            document.getElementById('categoryFilter').addEventListener('change', function () {
                filterProducts();
            });

            document.getElementById('statusFilter').addEventListener('change', function () {
                filterProducts();
            });

            // Reset filters
            document.getElementById('resetFilters').addEventListener('click', function () {
                document.getElementById('productSearch').value = '';
                document.getElementById('categoryFilter').value = '';
                document.getElementById('statusFilter').value = '';
                filterProducts();
            });

            // Initial filter to handle any pre-selected filters
            setTimeout(filterProducts, 100);
        });
        // Stats data management
        let statsData = {
            totalProducts: 0,
            totalStock: 0,
            totalInvestment: 0,
            lowStockCount: 0,
            previousStats: null
        };

        // Format currency based on shop settings
        function formatCurrency(amount) {
            const currency = getShopCurrency();
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency === 'PKR' ? 'PKR' : 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            // For PKR, we'll manually format since Intl doesn't support it well
            if (currency === 'PKR') {
                return 'â‚¨' + amount.toLocaleString('en-US');
            }
            
            return formatter.format(amount);
        }

        // Format large numbers with K, M suffixes
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Calculate trend (up, down, or neutral)
        function calculateTrend(current, previous) {
            if (!previous) return { direction: 'neutral', value: 0 };
            
            const change = current - previous;
            const percentage = previous > 0 ? (change / previous) * 100 : 0;
            
            if (change > 0) {
                return { direction: 'up', value: Math.abs(percentage.toFixed(1)) };
            } else if (change < 0) {
                return { direction: 'down', value: Math.abs(percentage.toFixed(1)) };
            } else {
                return { direction: 'neutral', value: 0 };
            }
        }

        // Update trend display
        function updateTrendDisplay(elementId, trend) {
            const element = document.getElementById(elementId);
            const icon = element.querySelector('.trend-icon');
            const text = element.querySelector('span:last-child');
            
            element.className = `trend-${trend.direction}`;
            
            if (trend.direction === 'up') {
                icon.className = 'fas fa-arrow-up trend-icon';
                text.textContent = `${trend.value}% increase`;
            } else if (trend.direction === 'down') {
                icon.className = 'fas fa-arrow-down trend-icon';
                text.textContent = `${trend.value}% decrease`;
            } else {
                icon.className = 'fas fa-minus trend-icon';
                text.textContent = 'No change';
            }
        }

        // Update progress bars based on data
        function updateProgressBars() {
            // For demo purposes, we'll set progress based on some arbitrary targets
            // In a real app, these would be based on your business metrics
            const productsProgress = Math.min((statsData.totalProducts / 100) * 100, 100);
            const stockProgress = Math.min((statsData.totalStock / 1000) * 100, 100);
            const investmentProgress = Math.min((statsData.totalInvestment / 50000) * 100, 100);
            const lowStockProgress = Math.min((statsData.lowStockCount / 20) * 100, 100);
            
            document.getElementById('productsProgress').style.width = `${productsProgress}%`;
            document.getElementById('stockProgress').style.width = `${stockProgress}%`;
            document.getElementById('investmentProgress').style.width = `${investmentProgress}%`;
            document.getElementById('lowStockProgress').style.width = `${lowStockProgress}%`;
        }

        // Update status messages
        function updateStatusMessages() {
            // Products status
            if (statsData.totalProducts === 0) {
                document.getElementById('productsStatus').textContent = 'No products yet';
            } else if (statsData.totalProducts < 10) {
                document.getElementById('productsStatus').textContent = 'Getting started';
            } else if (statsData.totalProducts < 50) {
                document.getElementById('productsStatus').textContent = 'Good variety';
            } else {
                document.getElementById('productsStatus').textContent = 'Excellent selection';
            }
            
            // Stock status
            if (statsData.totalStock === 0) {
                document.getElementById('stockStatus').textContent = 'No stock available';
            } else if (statsData.totalStock < 100) {
                document.getElementById('stockStatus').textContent = 'Limited stock';
            } else if (statsData.totalStock < 500) {
                document.getElementById('stockStatus').textContent = 'Adequate stock';
            } else {
                document.getElementById('stockStatus').textContent = 'Plenty in stock';
            }
            
            // Investment status
            if (statsData.totalInvestment === 0) {
                document.getElementById('investmentStatus').textContent = 'No investment';
            } else if (statsData.totalInvestment < 10000) {
                document.getElementById('investmentStatus').textContent = 'Low investment';
            } else if (statsData.totalInvestment < 50000) {
                document.getElementById('investmentStatus').textContent = 'Moderate investment';
            } else {
                document.getElementById('investmentStatus').textContent = 'High investment';
            }
            
            // Low stock status
            if (statsData.lowStockCount === 0) {
                document.getElementById('lowStockStatus').textContent = 'All items stocked';
            } else if (statsData.lowStockCount < 5) {
                document.getElementById('lowStockStatus').textContent = 'Few items low';
            } else if (statsData.lowStockCount < 15) {
                document.getElementById('lowStockStatus').textContent = 'Several items low';
            } else {
                document.getElementById('lowStockStatus').textContent = 'Many items low';
            }
        }

        // Update all stats displays
        function updateStatsDisplay() {
            // Update main values
            document.getElementById('totalProducts').textContent = formatNumber(statsData.totalProducts);
            document.getElementById('totalStock').textContent = formatNumber(statsData.totalStock);
            document.getElementById('totalInvestment').textContent = formatCurrency(statsData.totalInvestment);
            document.getElementById('lowStockCount').textContent = formatNumber(statsData.lowStockCount);
            
            // Update trends if we have previous data
            if (statsData.previousStats) {
                updateTrendDisplay('productsTrend', calculateTrend(statsData.totalProducts, statsData.previousStats.totalProducts));
                updateTrendDisplay('stockTrend', calculateTrend(statsData.totalStock, statsData.previousStats.totalStock));
                updateTrendDisplay('investmentTrend', calculateTrend(statsData.totalInvestment, statsData.previousStats.totalInvestment));
                updateTrendDisplay('lowStockTrend', calculateTrend(statsData.lowStockCount, statsData.previousStats.lowStockCount));
            }
            
            // Update progress bars and status messages
            updateProgressBars();
            updateStatusMessages();
        }

        // Fetch stats from server
        async function fetchStats() {
            try {
                // Show loading state
                document.getElementById('quickStats').classList.add('stat-loading');
                
                const response = await fetch('/products/stats');
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Store previous stats for trend calculation
                    statsData.previousStats = { ...statsData };
                    
                    // Update current stats
                    statsData.totalProducts = data.stats.totalProducts || 0;
                    statsData.totalStock = data.stats.totalStock || 0;
                    statsData.totalInvestment = data.stats.totalInvestment || 0;
                    statsData.lowStockCount = data.stats.lowStockCount || 0;
                    
                    // Update the display
                    updateStatsDisplay();
                    
                    // Remove loading state
                    document.getElementById('quickStats').classList.remove('stat-loading');
                } else {
                    throw new Error(data.message || 'Failed to fetch stats');
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
                // Remove loading state even on error
                document.getElementById('quickStats').classList.remove('stat-loading');
                
                // Show error in stats
                document.querySelectorAll('.stat-value').forEach(el => {
                    el.textContent = 'Error';
                });
            }
        }

        // Refresh stats manually
        function refreshStats() {
            // Add a quick visual feedback
            const refreshBtn = event.target.closest('.stat-action');
            const originalHtml = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing';
            
            fetchStats().finally(() => {
                // Restore original button content after a delay
                setTimeout(() => {
                    refreshBtn.innerHTML = originalHtml;
                }, 1000);
            });
        }

        // Navigate to stock alerts
        function viewStockAlerts() {
            window.location.href = '/products/alerts';
        }

        // Navigate to investment report (placeholder)
        function viewInvestmentReport() {
            alert('Investment report feature coming soon!');
            // In a real app: window.location.href = '/reports/investment';
        }

        // Initialize stats when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch initial stats
            fetchStats();
            
            // Set up auto-refresh every 5 minutes
            setInterval(fetchStats, 5 * 60 * 1000);
            
            // Rest of your existing DOMContentLoaded code...
        });

    </script>
</body>

</html>