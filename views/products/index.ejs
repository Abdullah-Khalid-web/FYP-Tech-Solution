<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - <%= shop.name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        :root {
            --primary: #4e73df;
            --success: #1cc88a;
            --warning: #f6c23e;
            --danger: #e74a3b;
            --info: #36b9cc;
            --secondary: #858796;
            --dark: #5a5c69;
            --light: #f8f9fc;
        }

        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-container {
            padding: 20px;
            background-color: #f5f7fa;
            min-height: calc(100vh - 70px);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .dashboard-header h1 {
            font-size: 1.8rem;
            margin: 0;
            color: var(--dark);
        }

        .datetime {
            color: var(--secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .shop-info {
            text-align: right;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            display: flex;
            align-items: center;
            padding: 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-right: 20px;
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin: 0;
        }

        .stat-info p {
            margin: 5px 0 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .section-header h2 {
            font-size: 1.2rem;
            margin: 0;
            display: flex;
            align-items: center;
            color: var(--dark);
        }

        .section-header h2 i {
            margin-right: 10px;
            color: var(--primary);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .action-card {
            background: white;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
            cursor: pointer;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 1.2rem;
            color: white;
        }

        .search-filter-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        .table th {
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.85rem;
            text-align: left;
            padding: 15px;
            background: #f8f9fc;
            border-bottom: 1px solid #e5e7eb;
        }

        .table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
            vertical-align: middle;
        }

        .table tr:hover td {
            background-color: #f8f9fc;
        }

        .badge {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.35em 0.65em;
        }

        .ingredient-badge {
            cursor: pointer;
        }

        .ingredient-badge:hover {
            opacity: 0.8;
        }

        .no-image-placeholder {
            width: 50px;
            height: 50px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 0;
        }

        .empty-state-icon {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 1rem;
        }

        .stock-badge {
            min-width: 70px;
        }

        /* Modal styles */
        .stock-entry {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .stock-entry:last-child {
            margin-bottom: 0;
        }

        .remove-entry {
            color: var(--danger);
            cursor: pointer;
        }

        .remove-entry:hover {
            color: #c82333;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                font-size: 12pt;
            }
            
            .table {
                font-size: 10pt;
            }
        }
    </style>
</head>

<body data-shop-currency="<%= shop.currency %>">
    <script>
        window.shopData = {
            currency: '<%= shop.currency %>',
            name: '<%= shop.name %>',
            primaryColor: '<%= shop.primary_color %>',
            secondaryColor: '<%= shop.secondary_color %>'
        };
    </script>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1><i class="fas fa-boxes me-2"></i>Product Management</h1>
                <p class="datetime" id="datetime"></p>
            </div>
            <div class="shop-info">
                <p><i class="fas fa-store"></i> <%= shop.name %></p>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-card bg-primary" onclick="window.location.reload()">
                <div class="stat-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalProducts">0</h3>
                    <p>Total Products</p>
                </div>
            </div>

            <div class="stat-card bg-success">
                <div class="stat-icon">
                    <i class="fas fa-cubes"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalStock">0</h3>
                    <p>Total Stock</p>
                </div>
            </div>

            <div class="stat-card bg-warning">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalValue">₨0</h3>
                    <p>Total Value</p>
                </div>
            </div>

            <div class="stat-card bg-danger" onclick="filterLowStock()">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="lowStockCount">0</h3>
                    <p>Low Stock</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions card">
            <div class="section-header">
                <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
            </div>
            <div class="action-grid">
                <div class="action-card" data-bs-toggle="modal" data-bs-target="#addProductModal">
                    <div class="action-icon bg-primary">
                        <i class="fas fa-plus"></i>
                    </div>
                    <p>Add Product</p>
                </div>
                
                <div class="action-card" onclick="window.location.href='/products/stock/add'">
                    <div class="action-icon bg-success">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <p>Add Stock</p>
                </div>
                
                <div class="action-card" onclick="window.location.href='/raw'">
                    <div class="action-icon bg-info">
                        <i class="fas fa-flask"></i>
                    </div>
                    <p>Raw Materials</p>
                </div>
                
                <div class="action-card" onclick="window.location.href='/suppliers'">
                    <div class="action-icon bg-warning">
                        <i class="fas fa-truck"></i>
                    </div>
                    <p>Suppliers</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter-card">
            <div class="section-header">
                <h2><i class="fas fa-filter"></i> Filter Products</h2>
            </div>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="productSearch" class="form-control" placeholder="Search products...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="categoryFilter" class="form-select">
                        <option value="">All Categories</option>
                        <% categories.forEach(category=> { %>
                            <option value="<%= category %>">
                                <%= category %>
                            </option>
                        <% }); %>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="resetFilters" class="btn btn-outline-primary w-100">
                        <i class="fas fa-sync-alt me-1"></i> Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> Products</h2>
                <span class="badge bg-primary" id="productCount">
                    <%= products.length %> products
                </span>
            </div>
            <div class="table-responsive">
                <table class="table" id="productsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Avg Cost</th>
                            <th>Ingredients</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (products.length) { %>
                            <% products.forEach(product=> { %>
                                <tr data-product-id="<%= product.id %>"
                                    data-category="<%= product.category || '' %>"
                                    data-status="<%= product.status %>">
                                    <td>
                                        <div class="fw-semibold"><%= product.name %></div>
                                        <% if (product.brand) { %>
                                            <small class="text-muted"><%= product.brand %></small>
                                        <% } %>
                                        <% if (product.sku) { %>
                                            <small class="text-muted d-block">SKU: <%= product.sku %></small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <%= product.category || 'Uncategorized' %>
                                    </td>
                                    <td>
                                        <span class="badge stock-badge <%= product.total_stock <= 5 ? 'bg-warning' : 'bg-success' %>">
                                            <%= product.total_stock %>
                                            <% if (product.total_stock <= 5) { %>
                                                <i class="fas fa-exclamation-triangle ms-1"></i>
                                            <% } %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="fw-semibold">₨<%= Number(product.avg_cost || 0).toFixed(2) %></span>
                                    </td>
                                    <td>
                                        <% if (product.ingredient_count > 0) { %>
                                            <span class="badge bg-info ingredient-badge"
                                                  onclick="viewIngredients('<%= product.id %>')">
                                                <%= product.ingredient_count %> ingredients
                                            </span>
                                        <% } else { %>
                                            <span class="badge bg-secondary">No ingredients</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <span class="badge <%= product.status === 'active' ? 'bg-success' : 'bg-secondary' %>">
                                            <%= product.status.charAt(0).toUpperCase() + product.status.slice(1) %>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary edit-product"
                                                    data-bs-toggle="tooltip" title="Edit Product">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-success add-stock"
                                                    data-bs-toggle="tooltip" title="Add Stock">
                                                <i class="fas fa-plus-circle"></i>
                                            </button>
                                            <button class="btn btn-outline-info view-ledger"
                                                    data-bs-toggle="tooltip" title="View Stock Ledger">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button class="btn btn-outline-<%= product.status === 'active' ? 'warning' : 'success' %> toggle-status"
                                                    data-bs-toggle="tooltip"
                                                    title="<%= product.status === 'active' ? 'Deactivate' : 'Activate' %>">
                                                <i class="fas <%= product.status === 'active' ? 'fa-toggle-on' : 'fa-toggle-off' %>"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">
                                            <i class="fas fa-box-open"></i>
                                        </div>
                                        <h5>No products found</h5>
                                        <p class="text-muted mb-3">Add your first product to get started</p>
                                        <button class="btn btn-primary" data-bs-toggle="modal"
                                                data-bs-target="#addProductModal">
                                            <i class="fas fa-plus me-2"></i>Add Product
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <% if (totalPages > 1) { %>
                <div class="card-footer border-top">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <% for (let i = 1; i <= totalPages; i++) { %>
                                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                    <a class="page-link" href="?page=<%= i %>">
                                        <%= i %>
                                    </a>
                                </li>
                            <% } %>
                            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addProductForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="productName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="productBrand" class="form-label">Brand</label>
                                    <input type="text" class="form-control" id="productBrand" name="brand">
                                </div>
                                <div class="mb-3">
                                    <label for="productCategory" class="form-label">Category</label>
                                    <input type="text" class="form-control" id="productCategory" name="category"
                                           list="categoryList">
                                    <datalist id="categoryList">
                                        <% categories.forEach(category=> { %>
                                            <option value="<%= category %>">
                                        <% }); %>
                                    </datalist>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productSize" class="form-label">Size</label>
                                    <input type="text" class="form-control" id="productSize" name="size">
                                </div>
                                <div class="mb-3">
                                    <label for="productSKU" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="productSKU" name="sku">
                                </div>
                                <div class="mb-3">
                                    <label for="productBarcode" class="form-label">Barcode</label>
                                    <input type="text" class="form-control" id="productBarcode" name="barcode">
                                </div>
                            </div>
                        </div>

                        <!-- Ingredients Section -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-flask me-2"></i>Ingredients (Optional)</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <select id="rawMaterialSelect" class="form-select me-2">
                                        <option value="">Select Raw Material</option>
                                        <% rawMaterials.forEach(material=> { %>
                                            <option value="<%= material.id %>" 
                                                    data-unit="<%= material.unit_of_measure %>"
                                                    data-stock="<%= material.current_stock %>">
                                                <%= material.name %> (<%= material.sku %>)
                                            </option>
                                        <% }); %>
                                    </select>
                                    <div class="input-group" style="width: 200px;">
                                        <input type="number" step="0.001" class="form-control" id="ingredientQuantity" 
                                               placeholder="Quantity" min="0.001">
                                        <span class="input-group-text" id="ingredientUnit">pcs</span>
                                    </div>
                                    <button type="button" class="btn btn-primary ms-2" onclick="addIngredient()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="ingredientsList" class="mt-3">
                                    <!-- Added ingredients will be listed here -->
                                    <p class="text-muted mb-0">No ingredients added</p>
                                </div>
                                <input type="hidden" id="ingredientsData" name="ingredients" value="[]">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editProductForm">
                    <input type="hidden" id="editProductId" name="id">
                    <div class="modal-body">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Loading product details...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal fade" id="addStockModal" tabindex="-1" aria-labelledby="addStockModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStockModalLabel">Add Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addStockForm">
                    <input type="hidden" id="stockProductId" name="product_id">
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h5 id="stockProductName"></h5>
                                <div class="row small text-muted">
                                    <div class="col-md-4">
                                        <strong>SKU:</strong> <span id="stockProductSKU"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Category:</strong> <span id="stockProductCategory"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Current Stock:</strong> <span id="currentStock" class="badge bg-primary"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Entries Container -->
                        <div id="stockEntriesContainer">
                            <div class="stock-entry">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Batch Number</label>
                                        <input type="text" class="form-control stock-batch" placeholder="Optional">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Quantity *</label>
                                        <input type="number" step="0.001" class="form-control stock-quantity" required min="0.001">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Unit Price *</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₨</span>
                                            <input type="number" step="0.01" class="form-control stock-price" required min="0">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Supplier</label>
                                        <select class="form-select stock-supplier">
                                            <option value="">Select Supplier</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Expiry Date</label>
                                        <input type="date" class="form-control stock-expiry">
                                    </div>
                                    <div class="col-md-1 d-flex align-items-end">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeStockEntry(this)" style="display: none;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control stock-notes" rows="1" placeholder="Optional notes"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addStockEntry()">
                                <i class="fas fa-plus me-1"></i>Add Another Stock Entry
                            </button>
                        </div>

                        <!-- Total Calculation -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6>Total Quantity: <span id="totalQuantity" class="fw-bold">0</span></h6>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Total Value: <span id="totalValue" class="fw-bold">₨0.00</span></h6>
                                    </div>
                                    <div class="col-md-4">
                                        <h6>Average Price: <span id="averagePrice" class="fw-bold">₨0.00</span></h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Stock</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Ingredients Modal -->
    <div class="modal fade" id="viewIngredientsModal" tabindex="-1" aria-labelledby="viewIngredientsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewIngredientsModalLabel">Product Ingredients</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="ingredientsModalContent">
                        <!-- Ingredients will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Ledger Modal -->
    <div class="modal fade" id="viewLedgerModal" tabindex="-1" aria-labelledby="viewLedgerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewLedgerModalLabel">Stock Ledger</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="ledgerModalContent">
                        <!-- Ledger will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Toastr configuration
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000"
        };

        // Update datetime
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('en-IN', options);
        }
        setInterval(updateDateTime, 60000);
        updateDateTime();

        // Global variables
        let ingredients = [];
        let editIngredients = [];
        let currentProductId = null;
        let suppliers = [];

        // Load stats on page load
        async function loadStats() {
            try {
                const response = await fetch('/products/stats');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('totalProducts').textContent = data.stats.totalProducts;
                        document.getElementById('totalStock').textContent = data.stats.totalStock;
                        document.getElementById('totalValue').textContent = data.stats.totalValue;
                        document.getElementById('lowStockCount').textContent = data.stats.lowStockCount;
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Filter functions
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            let visibleCount = 0;

            document.querySelectorAll('#productsTable tbody tr[data-product-id]').forEach(row => {
                const name = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                const category = row.getAttribute('data-category') ? row.getAttribute('data-category').toLowerCase() : '';
                const status = row.getAttribute('data-status') ? row.getAttribute('data-status').toLowerCase() : '';

                const matchesSearch = searchTerm === '' || name.includes(searchTerm);
                const matchesCategory = categoryFilter === '' || category === categoryFilter;
                const matchesStatus = statusFilter === '' || status === statusFilter;

                const shouldShow = matchesSearch && matchesCategory && matchesStatus;
                row.style.display = shouldShow ? '' : 'none';

                if (shouldShow) visibleCount++;
            });

            document.getElementById('productCount').textContent = `${visibleCount} products`;
        }

        function filterLowStock() {
            document.getElementById('productSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterProducts();
        }

        // Ingredient management for add product
        function addIngredient() {
            const rawMaterialSelect = document.getElementById('rawMaterialSelect');
            const quantityInput = document.getElementById('ingredientQuantity');
            const unitSpan = document.getElementById('ingredientUnit');

            if (!rawMaterialSelect.value || !quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                toastr.error('Please select a raw material and enter a valid quantity');
                return;
            }

            const selectedOption = rawMaterialSelect.options[rawMaterialSelect.selectedIndex];
            const ingredient = {
                raw_material_id: rawMaterialSelect.value,
                raw_material_name: selectedOption.text.split(' (')[0],
                quantity: parseFloat(quantityInput.value),
                unit: unitSpan.textContent
            };

            ingredients.push(ingredient);
            updateIngredientsList();
            updateIngredientsData();

            // Reset form
            rawMaterialSelect.value = '';
            quantityInput.value = '';
        }

        function updateIngredientsList() {
            const container = document.getElementById('ingredientsList');
            container.innerHTML = '';

            if (ingredients.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">No ingredients added</p>';
                return;
            }

            ingredients.forEach((ingredient, index) => {
                const div = document.createElement('div');
                div.className = 'ingredient-item mb-2 p-2 border rounded d-flex justify-content-between align-items-center';
                div.innerHTML = `
                    <div>
                        <strong>${escapeHtml(ingredient.raw_material_name)}</strong>
                        <div class="small text-muted">
                            Quantity: ${ingredient.quantity} ${ingredient.unit}
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeIngredient(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function removeIngredient(index) {
            ingredients.splice(index, 1);
            updateIngredientsList();
            updateIngredientsData();
        }

        function updateIngredientsData() {
            document.getElementById('ingredientsData').value = JSON.stringify(ingredients);
        }

        // Handle raw material selection change
        document.getElementById('rawMaterialSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('ingredientUnit').textContent = selectedOption.getAttribute('data-unit');
            }
        });

        // Handle add product form
        document.getElementById('addProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            data.ingredients = document.getElementById('ingredientsData').value;

            try {
                const response = await fetch('/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    toastr.success(result.message);
                    $('#addProductModal').modal('hide');
                    // Reset form
                    document.getElementById('addProductForm').reset();
                    ingredients = [];
                    updateIngredientsList();
                    updateIngredientsData();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                toastr.error('An error occurred while adding product');
            }
        });

        // Handle edit product
        async function loadProductForEdit(productId) {
            try {
                const response = await fetch(`/products/${productId}/edit`);
                const data = await response.json();

                if (data.success) {
                    const product = data.product;
                    const modalBody = document.querySelector('#editProductModal .modal-body');
                    
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" name="name" value="${escapeHtml(product.name)}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" name="brand" value="${escapeHtml(product.brand || '')}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <input type="text" class="form-control" name="category" value="${escapeHtml(product.category || '')}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Size</label>
                                    <input type="text" class="form-control" name="size" value="${escapeHtml(product.size || '')}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SKU</label>
                                    <input type="text" class="form-control" name="sku" value="${escapeHtml(product.sku || '')}">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Barcode</label>
                                    <input type="text" class="form-control" name="barcode" value="${escapeHtml(product.barcode || '')}">
                                </div>
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status">
                                <option value="active" ${product.status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="inactive" ${product.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                            </select>
                        </div>

                        <!-- Ingredients Section -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-flask me-2"></i>Ingredients (Optional)</h6>
                            </div>
                            <div class="card-body">
                                <div id="editIngredientsList" class="mb-3">
                                    <!-- Existing ingredients will be shown here -->
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <select id="editRawMaterialSelect" class="form-select me-2">
                                        <option value="">Select Raw Material</option>
                                        ${data.rawMaterials.map(material => `
                                            <option value="${material.id}" 
                                                    data-unit="${material.unit_of_measure}"
                                                    data-stock="${material.current_stock}">
                                                ${escapeHtml(material.name)} (${escapeHtml(material.sku)})
                                            </option>
                                        `).join('')}
                                    </select>
                                    <div class="input-group" style="width: 200px;">
                                        <input type="number" step="0.001" class="form-control" id="editIngredientQuantity" 
                                               placeholder="Quantity" min="0.001">
                                        <span class="input-group-text" id="editIngredientUnit">pcs</span>
                                    </div>
                                    <button type="button" class="btn btn-primary ms-2" onclick="addEditIngredient()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <input type="hidden" id="editIngredientsData" name="ingredients" value="[]">
                            </div>
                        </div>

                        <!-- Stock Info (Readonly) -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-box me-2"></i>Current Stock Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Current Stock:</strong> ${product.current_quantity}</p>
                                        <p><strong>Average Cost:</strong> ₨${Number(product.avg_cost).toFixed(2)}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Total Value:</strong> ₨${Number(product.current_quantity * product.avg_cost).toFixed(2)}</p>
                                        <p><small class="text-muted">To update stock, use the "Add Stock" button</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Set product ID
                    document.getElementById('editProductId').value = productId;

                    // Initialize edit ingredients
                    editIngredients = data.ingredients;
                    updateEditIngredientsList();

                    // Handle raw material selection change
                    document.getElementById('editRawMaterialSelect').addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption.value) {
                            document.getElementById('editIngredientUnit').textContent = selectedOption.getAttribute('data-unit');
                        }
                    });

                    $('#editProductModal').modal('show');
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                toastr.error('Error loading product');
            }
        }

        function updateEditIngredientsList() {
            const container = document.getElementById('editIngredientsList');
            container.innerHTML = '';

            if (editIngredients.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">No ingredients added</p>';
                return;
            }

            editIngredients.forEach((ingredient, index) => {
                const div = document.createElement('div');
                div.className = 'ingredient-item mb-2 p-2 border rounded d-flex justify-content-between align-items-center';
                div.innerHTML = `
                    <div>
                        <strong>${escapeHtml(ingredient.raw_material_name)}</strong>
                        <div class="small text-muted">
                            Quantity: ${ingredient.quantity_required} ${ingredient.unit}
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeEditIngredient(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            });

            document.getElementById('editIngredientsData').value = JSON.stringify(editIngredients.map(ing => ({
                raw_material_id: ing.raw_material_id,
                quantity: ing.quantity_required,
                unit: ing.unit
            })));
        }

        function addEditIngredient() {
            const rawMaterialSelect = document.getElementById('editRawMaterialSelect');
            const quantityInput = document.getElementById('editIngredientQuantity');
            const unitSpan = document.getElementById('editIngredientUnit');

            if (!rawMaterialSelect.value || !quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                toastr.error('Please select a raw material and enter a valid quantity');
                return;
            }

            const selectedOption = rawMaterialSelect.options[rawMaterialSelect.selectedIndex];
            const ingredient = {
                raw_material_id: rawMaterialSelect.value,
                raw_material_name: selectedOption.text.split(' (')[0],
                quantity_required: parseFloat(quantityInput.value),
                unit: unitSpan.textContent
            };

            editIngredients.push(ingredient);
            updateEditIngredientsList();

            // Reset form
            rawMaterialSelect.value = '';
            quantityInput.value = '';
        }

        function removeEditIngredient(index) {
            editIngredients.splice(index, 1);
            updateEditIngredientsList();
        }

        // Handle edit form submission
        document.getElementById('editProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            data.ingredients = document.getElementById('editIngredientsData').value;

            try {
                const response = await fetch(`/products/${data.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    toastr.success(result.message);
                    $('#editProductModal').modal('hide');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                toastr.error('An error occurred');
            }
        });

        // Handle add stock
        async function loadAddStockModal(productId) {
            currentProductId = productId;

            // Get product info
            const row = document.querySelector(`tr[data-product-id="${productId}"]`);
            const productName = row.querySelector('td:nth-child(1) .fw-semibold').textContent;
            const productSKU = row.querySelector('td:nth-child(1) .text-muted.d-block')?.textContent?.replace('SKU: ', '') || 'N/A';
            const category = row.querySelector('td:nth-child(2)').textContent;
            const currentStock = row.querySelector('td:nth-child(3) .badge').textContent;

            // Populate modal
            document.getElementById('stockProductName').textContent = productName;
            document.getElementById('stockProductSKU').textContent = productSKU;
            document.getElementById('stockProductCategory').textContent = category;
            document.getElementById('currentStock').textContent = currentStock;
            document.getElementById('stockProductId').value = productId;

            // Load suppliers
            await loadSuppliers();

            // Reset entries
            document.getElementById('stockEntriesContainer').innerHTML = `
                <div class="stock-entry">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Batch Number</label>
                            <input type="text" class="form-control stock-batch" placeholder="Optional">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantity *</label>
                            <input type="number" step="0.001" class="form-control stock-quantity" required min="0.001">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Unit Price *</label>
                            <div class="input-group">
                                <span class="input-group-text">₨</span>
                                <input type="number" step="0.01" class="form-control stock-price" required min="0">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Supplier</label>
                            <select class="form-select stock-supplier">
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Expiry Date</label>
                            <input type="date" class="form-control stock-expiry">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeStockEntry(this)" style="display: none;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control stock-notes" rows="1" placeholder="Optional notes"></textarea>
                        </div>
                    </div>
                </div>
            `;

            // Populate suppliers in first entry
            const firstSupplierSelect = document.querySelector('.stock-supplier');
            populateSuppliersSelect(firstSupplierSelect);

            // Add event listeners for calculations
            addStockEntryListeners();

            // Calculate totals
            calculateStockTotals();

            $('#addStockModal').modal('show');
        }

        async function loadSuppliers() {
            try {
                const response = await fetch('/products/suppliers/list');
                const data = await response.json();

                if (data.success) {
                    suppliers = data.suppliers;
                }
            } catch (error) {
                console.error('Error loading suppliers:', error);
                toastr.error('Error loading suppliers');
            }
        }

        function populateSuppliersSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Select Supplier</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = `${supplier.name}${supplier.contact_person ? ` (${supplier.contact_person})` : ''}`;
                selectElement.appendChild(option);
            });
        }

        function addStockEntry() {
            const container = document.getElementById('stockEntriesContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'stock-entry mt-3';
            newEntry.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Batch Number</label>
                        <input type="text" class="form-control stock-batch" placeholder="Optional">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Quantity *</label>
                        <input type="number" step="0.001" class="form-control stock-quantity" required min="0.001">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Unit Price *</label>
                        <div class="input-group">
                            <span class="input-group-text">₨</span>
                            <input type="number" step="0.01" class="form-control stock-price" required min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Supplier</label>
                        <select class="form-select stock-supplier">
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" class="form-control stock-expiry">
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeStockEntry(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control stock-notes" rows="1" placeholder="Optional notes"></textarea>
                    </div>
                </div>
            `;

            container.appendChild(newEntry);
            
            // Populate suppliers in new entry
            const newSupplierSelect = newEntry.querySelector('.stock-supplier');
            populateSuppliersSelect(newSupplierSelect);
            
            // Add event listeners
            addStockEntryListeners(newEntry);
            
            // Show remove buttons on all entries except first
            document.querySelectorAll('.stock-entry').forEach((entry, index) => {
                const removeBtn = entry.querySelector('.btn-danger');
                if (removeBtn) {
                    removeBtn.style.display = index === 0 ? 'none' : 'block';
                }
            });
        }

        function removeStockEntry(button) {
            const entry = button.closest('.stock-entry');
            entry.remove();
            
            // Show remove buttons on all entries except first
            document.querySelectorAll('.stock-entry').forEach((entry, index) => {
                const removeBtn = entry.querySelector('.btn-danger');
                if (removeBtn) {
                    removeBtn.style.display = index === 0 ? 'none' : 'block';
                }
            });
            
            calculateStockTotals();
        }

        function addStockEntryListeners(entry = null) {
            const elements = entry ? 
                entry.querySelectorAll('.stock-quantity, .stock-price') :
                document.querySelectorAll('.stock-quantity, .stock-price');
            
            elements.forEach(element => {
                element.addEventListener('input', calculateStockTotals);
            });
        }

        function calculateStockTotals() {
            let totalQuantity = 0;
            let totalValue = 0;
            
            document.querySelectorAll('.stock-entry').forEach(entry => {
                const quantity = parseFloat(entry.querySelector('.stock-quantity').value) || 0;
                const price = parseFloat(entry.querySelector('.stock-price').value) || 0;
                
                totalQuantity += quantity;
                totalValue += quantity * price;
            });
            
            const averagePrice = totalQuantity > 0 ? totalValue / totalQuantity : 0;
            
            document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(3);
            document.getElementById('totalValue').textContent = '₨' + totalValue.toFixed(2);
            document.getElementById('averagePrice').textContent = '₨' + averagePrice.toFixed(2);
        }

        // Handle add stock form
        document.getElementById('addStockForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const stockEntries = [];
            let isValid = true;
            
            document.querySelectorAll('.stock-entry').forEach(entry => {
                const quantity = entry.querySelector('.stock-quantity').value;
                const price = entry.querySelector('.stock-price').value;
                
                if (!quantity || !price || parseFloat(quantity) <= 0 || parseFloat(price) <= 0) {
                    isValid = false;
                    toastr.error('Please fill all required fields with valid values');
                    return;
                }
                
                stockEntries.push({
                    batch_number: entry.querySelector('.stock-batch').value,
                    quantity: parseFloat(quantity),
                    unit_price: parseFloat(price),
                    expiry_date: entry.querySelector('.stock-expiry').value || null,
                    supplier_id: entry.querySelector('.stock-supplier').value || null,
                    notes: entry.querySelector('.stock-notes').value
                });
            });
            
            if (!isValid || stockEntries.length === 0) {
                return;
            }
            
            try {
                const response = await fetch(`/products/${currentProductId}/stock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ stock_entries: stockEntries })
                });

                const data = await response.json();

                if (data.success) {
                    toastr.success(data.message);
                    $('#addStockModal').modal('hide');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                toastr.error('An error occurred while adding stock');
            }
        });

        // View ingredients
        async function viewIngredients(productId) {
            try {
                const response = await fetch(`/products/${productId}/edit`);
                const data = await response.json();

                if (data.success) {
                    const content = document.getElementById('ingredientsModalContent');
                    
                    if (data.ingredients.length === 0) {
                        content.innerHTML = '<p class="text-muted">No ingredients found for this product.</p>';
                    } else {
                        content.innerHTML = `
                            <h6>Ingredients for: ${escapeHtml(data.product.name)}</h6>
                            <div class="table-responsive mt-3">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Raw Material</th>
                                            <th>SKU</th>
                                            <th>Quantity Required</th>
                                            <th>Unit</th>
                                            <th>Current Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.ingredients.map(ingredient => `
                                            <tr>
                                                <td>${escapeHtml(ingredient.raw_material_name)}</td>
                                                <td>${escapeHtml(ingredient.raw_material_sku || 'N/A')}</td>
                                                <td>${ingredient.quantity_required}</td>
                                                <td>${ingredient.unit}</td>
                                                <td>
                                                    <span class="badge ${ingredient.current_stock >= ingredient.quantity_required ? 'bg-success' : 'bg-danger'}">
                                                        ${ingredient.current_stock} ${ingredient.unit}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    $('#viewIngredientsModal').modal('show');
                }
            } catch (error) {
                console.error('Error:', error);
                toastr.error('Error loading ingredients');
            }
        }

        // View ledger
        async function viewLedger(productId) {
            currentProductId = productId;
            
            try {
                const response = await fetch(`/products/${productId}/ledger`);
                const data = await response.json();

                if (data.success) {
                    const content = document.getElementById('ledgerModalContent');
                    
                    content.innerHTML = `
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h5>${escapeHtml(data.product.name)}</h5>
                                <div class="row small text-muted">
                                    <div class="col-md-4">
                                        <strong>SKU:</strong> ${escapeHtml(data.product.sku || 'N/A')}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Category:</strong> ${escapeHtml(data.product.category || 'N/A')}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Total Stock:</strong> ${data.product.total_stock}
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${data.ledger.length === 0 ? 
                            '<p class="text-muted">No stock entries found.</p>' : 
                            `
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Batch</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Total Value</th>
                                            <th>Supplier</th>
                                            <th>Received By</th>
                                            <th>Notes</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.ledger.map(entry => `
                                            <tr>
                                                <td>${new Date(entry.date_added).toLocaleDateString()}</td>
                                                <td>${escapeHtml(entry.batch_number || 'N/A')}</td>
                                                <td>${entry.quantity}</td>
                                                <td>₨${Number(entry.unit_price).toFixed(2)}</td>
                                                <td>₨${Number(entry.total_value).toFixed(2)}</td>
                                                <td>${escapeHtml(entry.supplier_name || 'N/A')}</td>
                                                <td>${escapeHtml(entry.received_by || 'N/A')}</td>
                                                <td>${escapeHtml(entry.notes || '')}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-danger delete-stock-entry" 
                                                            data-stock-id="${entry.id}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `
                        }
                    `;

                    // Add delete event listeners
                    document.querySelectorAll('.delete-stock-entry').forEach(button => {
                        button.addEventListener('click', async function() {
                            const stockId = this.getAttribute('data-stock-id');
                            if (confirm('Are you sure you want to delete this stock entry? This will also update supplier balance if applicable.')) {
                                try {
                                    const response = await fetch(`/products/stock/${stockId}`, {
                                        method: 'DELETE'
                                    });
                                    
                                    const data = await response.json();
                                    
                                    if (data.success) {
                                        toastr.success(data.message);
                                        viewLedger(productId); // Refresh ledger
                                    } else {
                                        toastr.error(data.message);
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    toastr.error('Error deleting stock entry');
                                }
                            }
                        });
                    });

                    $('#viewLedgerModal').modal('show');
                }
            } catch (error) {
                console.error('Error:', error);
                toastr.error('Error loading ledger');
            }
        }

        // Toggle status
        async function toggleProductStatus(productId) {
            if (!confirm('Are you sure you want to change the status of this product?')) return;

            try {
                const response = await fetch(`/products/${productId}/toggle-status`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    toastr.success(data.message);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    toastr.error(data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                toastr.error('An error occurred');
            }
        }

        // Event listeners for table buttons
        document.addEventListener('click', function(e) {
            // Edit product
            if (e.target.closest('.edit-product')) {
                const productId = e.target.closest('tr').getAttribute('data-product-id');
                loadProductForEdit(productId);
            }

            // Add stock
            if (e.target.closest('.add-stock')) {
                const productId = e.target.closest('tr').getAttribute('data-product-id');
                loadAddStockModal(productId);
            }

            // View ledger
            if (e.target.closest('.view-ledger')) {
                const productId = e.target.closest('tr').getAttribute('data-product-id');
                viewLedger(productId);
            }

            // Toggle status
            if (e.target.closest('.toggle-status')) {
                const productId = e.target.closest('tr').getAttribute('data-product-id');
                toggleProductStatus(productId);
            }
        });

        // Search and filter events
        document.getElementById('productSearch').addEventListener('input', filterProducts);
        document.getElementById('categoryFilter').addEventListener('change', filterProducts);
        document.getElementById('statusFilter').addEventListener('change', filterProducts);
        document.getElementById('resetFilters').addEventListener('click', function() {
            document.getElementById('productSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterProducts();
        });

        // Helper function to escape HTML
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            filterProducts();
        });
    </script>
</body>
</html>